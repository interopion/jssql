!function(a,b){"use strict";function c(a,b){return Gb.call(a)=="[object "+b+"]"}function d(a,c){var e=parseInt(a,10);return(isNaN(e)||!isFinite(e))&&(e=c===b?0:d(c)),e}function e(a,b){if(a=parseFloat(a),isNaN(a)||!isFinite(a))return a;if(!b||isNaN(b)||!isFinite(b))return Math.round(a);if(0>b)return f(a,b);var c=Math.pow(10,b);return Math.round(a*c)/c}function f(a,b){if(b=b||0,0===b)return 0>a?Math.ceil(a):Math.floor(a);if(0>b)return b=Math.pow(10,-1*b),Math.floor(a/b)*b;var c=String(a).split("."),d=c[0],e=c[1]||"0";return b=Math.pow(10,Math.max(0,e.length-b)),parseFloat(d+"."+Math.floor(e/b)*b)}function g(a){var b=arguments,c=b.length,d=0;return String(a||"").replace(/(%s)/g,function(){return++d>c?"":b[d]})}function h(a){var b,c=a.length;if(0===c)return"";if(1===c)return i(a[0]);if(2==c)return i(a[0])+" or "+i(a[1]);var d,e=[];for(d=0;d<a.length;d++)e.push(i(a[d]));return b=e.pop(),"one of "+e.join(", ")+" or "+b}function i(a,b){return b=b||'"',b+String(a).replace(b,b+""+b)+b}function j(a){return r(a)?a:a&&"function"==typeof a.toArray?j(a.toArray()):a&&"object"==typeof a&&"length"in a?Array.prototype.slice.call(a):[a]}function k(a){a="string"==typeof a?{message:a}:a||{message:"Unknown error"};var b,c,d,e=Array.prototype.slice.call(arguments,1),f=[];throw e.unshift(a.message),b=d=g.apply({},e),f.push("font-weight:bold;color:red;",b),b="%c%s","file"in a&&(b+="%c \n   file: %s",f.push("font-weight:bold;",a.file)),"line"in a&&(b+="%c \n   line: %i",f.push("font-weight:bold",a.line)),"col"in a&&(b+="%c \n column: %i",f.push("font-weight:bold",a.col)),"token"in a&&(b+="%c \n   char: %i",f.push("font-weight:bold",a.token[2]),"src"in a&&(c=Math.max(a.token[2]-50,0),b+="%c \n around: %c%s%c%s%c%s",f.push("font-weight:bold","color:#666","..."+a.src.substring(c,a.token[2]),"color:#000;font-weight:bold;background:orange;padding:3px;border-radius:3px;text-indent:5px;display:inline-block !important;",a.src.substring(a.token[2],a.token[3]).replace(/\n/g,"Â¬\n"),"color:#666",a.src.substr(a.token[3],50)+"..."))),f.unshift(b),console.log.apply(console,f),new SyntaxError(d)}function l(a){return String(a).replace(wb,"")}function m(a,b){function c(){g++,b.onBlockOpen&&b.onBlockOpen(g)}function d(){g--,b.onBlockClose&&b.onBlockClose(g)}function e(a){f[h++]=a}var f=[],g=0,h=0;if(b=b||{},W(a,e,c,d,b),g>0)throw new SyntaxError("Unclosed block");if(0>g)throw new SyntaxError("Extra closing block");return f}function n(a,b,d){var e,f,g=arguments.length;if(2>g||!a||"object"!=typeof a)throw"Invalid arguments";if(c(a,"Array")){for(f=a.length,e=0;f>e;e++)if(g>2){if(b.call(d,a[e],e,a)===!1)break}else if(b(a[e],e,a)===!1)break}else for(e in a)if(g>2){if(b.call(d,a[e],e,a)===!1)break}else if(b(a[e],e,a)===!1)break}function o(a,b,d){var e,f,g=arguments.length;if(2>g||!a||"object"!=typeof a)return!1;if(c(a,"Array")){if("function"==typeof a.every)return a.every(b,d);for(f=a.length,e=0;f>e;e++)if(g>2){if(b.call(d,a[e],e,a)===!1)return!1}else if(b(a[e],e,a)===!1)return!1}else for(e in a)if(g>2){if(b.call(d,a[e],e,a)===!1)return!1}else if(b(a[e],e,a)===!1)return!1;return!0}function p(a,b){var c,d=[];for(c in a)(b||a.hasOwnProperty(c))&&d.push(c);return d}function q(){}function r(a){return c(a,"Array")}function s(a){return c(a,"Function")}function t(a){return l(1*a)===l(a)}function u(a,c,d,e,f){var g,h;if(e===b)e=0;else if(e=0|e,0>e||e>=a.length)throw new RangeError("invalid lower bound");if(f===b)f=a.length-1;else if(f=0|f,e>f||f>=a.length)throw new RangeError("invalid upper bound");for(;f>=e;)if(g=e+(f-e>>1),h=+d(a[g],c),0>h)e=g+1;else{if(!(h>0))return g;f=g-1}return~e}function v(a,b,d){if(!c(a,b))throw new TypeError(d||"Invalid type ('"+b+"' is required)")}function w(a,b,c){if(!(a instanceof b))throw new TypeError(c||"Invalid object type")}function x(a,b,c){if(0>a||a>=b.length)throw new RangeError(c||"value out of bounds")}function y(a,b,c){if(!(a in b))throw new Error(c||"No such property '"+a+"'.")}function z(a,b){if(!a)throw new Error(b||"Assertion failed")}function A(a){return s(a)?a:function(a){if(a)throw a}}function B(){var a,b,c,d,e,f,g=arguments.length;if(!(1>g)){if(e=arguments[0],1===g)return B(r(e)?[]:{},e);for(d=1;g>d;d++)if(f=arguments[d],r(f))for(b=f.length,a=0;b>a;a++)c=f[a],e[a]=c&&"object"==typeof c?B(r(c)?[]:{},e[a],c):c;else if(f&&"object"==typeof f)for(a in f)f.hasOwnProperty(a)&&(c=f[a],e[a]=c&&"object"==typeof c?B(r(c)?[]:{},e[a],c):c);return e}}function C(a,b){for(var c=b||1,d=String(a).length;d++<c;)a="0"+a;return a}function D(a){var b=new Date(a.getFullYear(),0,1);return Math.floor((a.getTime()+Db-b)/Eb)}function E(a){return I(a||"%Y-%m-%dT%H:%M:%f%z",this)}function F(a){var b,c=new Date(0,0,1,0,0,0,0),d=String(a).match(xb);return d?(c.setFullYear(parseInt(d[2]||0,10)),c.setMonth(parseInt((d[3]||1)-1,10)),c.setDate(parseInt(d[4]||1,10)),c.setHours(parseInt(d[6]||0,10)),c.setMinutes(parseInt(d[7]||0,10)),c.setSeconds(parseInt(d[9]||0,10)),c.setMilliseconds(parseInt(d[11]||0,10)),b=String(d[12]).toUpperCase(),"Z"==b?c._offset=0:d[14]&&(d[15]&&(c._offset=parseInt(d[14]+d[15],10)*Cb),d[17]&&(c._offset+=parseInt(d[14]+d[17],10)*Bb))):c.setFullYear(0),c.toString=E,c}function G(a,b){var c,d=Object.prototype.toString.call(a);return c="[object Date]"==d?a:"[object Number]"==d?new Date(a):"[object String]"!=d?F(0):"now"==a.toLowerCase()?new Date(Date.now()):t(a)?new Date(1*a):F(a),isNaN(1*c)||(b=r(b)?b:j(arguments).slice(1),b.forEach(function(a){H(c,a)})),c.toString=E,c}function H(a,b){var c,d=b.match(/^\s*([+-]?\d+(\.\d+)?\s+)?(.*)?\s*$/);if(d)if(d[1]){var e=parseFloat(d[1]);switch(d[3].toLowerCase()){case"days":c=a.getDate(),a.setDate(c+e);break;case"hours":c=a.getHours(),a.setHours(c+e);break;case"minutes":c=a.getMinutes(),a.setMinutes(c+e);break;case"seconds":c=a.getSeconds(),a.setSeconds(c+e);break;case"months":c=a.getMonth(),a.setMonth(c+e);break;case"years":c=a.getFullYear(),a.setFullYear(c+e);break;default:return}}else switch(d[3].toLowerCase()){case"start of month":a.setDate(1),a.setHours(0,0,0,0);break;case"start of year":a.setMonth(0,1),a.setHours(0,0,0,0);break;case"start of day":a.setHours(0,0,0,0);break;case"localtime":a._offset&&a.setTime(a.getTime()-a._offset),a._offset=a.getTimezoneOffset()*Bb,a.setTime(a.getTime()+a._offset);break;case"utc":a._offset&&(a.setTime(a.getTime()-a._offset),a._offset=0);break;default:var f,g,h=d[3].match(/weekday\s+([0-6])/);h&&(g=a.getDay(),f=parseInt(h[1]),a.setDate(a.getDate()+(g>f?7+f-g:f-g)))}}function I(a,b,c){return a=a||yb,c=Array.prototype.slice.call(arguments,2),b=G(b||"now",c),a.replace(/%%/g,"__DOUBLE_%__").replace(/%d/g,C(b.getDate(),2)).replace(/%f/g,C(b.getSeconds(),2)+"."+C(b.getMilliseconds(),3)).replace(/%H/g,C(b.getHours(),2)).replace(/%j/g,C(Math.ceil((+b-1*new Date(b.getFullYear(),0,0,24,0,0,0))/Db),3)).replace(/%m/g,C(b.getMonth()+1,2)).replace(/%M/g,C(b.getMinutes(),2)).replace(/%s/g,+b).replace(/%S/g,C(b.getSeconds(),2)).replace(/%w/g,b.getDay()).replace(/%W/g,C(D(b),2)).replace(/%Y/g,C(b.getFullYear(),4)).replace(/%z/g,0===b._offset?"Z":b._offset?(b._offset<0?"-":"+")+C(Math.floor(Math.abs(b._offset)/Cb),2)+C(Math.floor(Math.abs(b._offset)%Cb/Bb),2):"").replace(/__DOUBLE_%__/g,"%")}function J(a){var b,c=[],d=[],e=B({},Hb,a.sandbox),f=a.translations||{},g=a.scope||{},h=a.code||"",i=a.context||null===a.context?a.context:{};for(b in e)c.push(b),d.push(e[b]);for(b in g)vb.test(b)&&(c.push(b),d.push(g[b]));for(b in f)h=h.replace(new RegExp(b,"gi"),f[b]);return h=h.replace(/^(\s*return\s+)?/,"return "),new Function(c.join(", "),h).apply(i,d)}function K(a,b,c){return J({code:a,sandbox:c||{},translations:{"={1,}":"===","\\bOR\\b":"||","\\bAND\\b":"&&","!={1,}":"!==","(__scope__\\[[^\\]]+\\])\\s*LIKE\\s*('[^']*')":function(a,b,c){return"LIKE("+b+", "+c+")"}},scope:b,context:{}})}function L(a){for(var b,c,d,e,f,g,h,i=a.length,j=0,k=[];i>j;){if(g=a[j],c=g.length,0===j)for(b=0;c>b;b++)e=k.push(B(g[b]));else for(d=0;e>d;d++)for(f=B(k[d]),h=0,b=0;c>b;b++)1===++h?B(k[d],g[b]):(k.splice(++d,0,B({},f,g[b])),e++);j++}return k}function M(a){for(var b,c,d,e,f,g,h,i=a.slice(),j=i.length,k=0;j--;)if(c=i.shift(),b)for(g=0;k>g;g++){h=0,f=b[g];for(d in c.rows)e=f.concat(c.rows[d]._data),1===++h?b[g]=e:(b.splice(++g,0,e),k++)}else{b=[];for(d in c.rows)k=b.push(c.rows[d]._data.slice())}return b||[]}function N(a,b){console.time("innerJoin");var c=M(a).filter(b);return console.timeEnd("innerJoin"),c}function O(){}function P(a){function b(a){a[2]+=k,a[3]+=k,d=a[3],e.tokens.push(a)}a=Q(a);for(var c,d,e,f,g=new O,h=m(a,{skipComments:!0,skipSpace:!0,skipEol:!0,skipStrQuots:!0}),i=new X(h,a),j=h.length,k=0;i._pos<j-1&&(e={sql:"",tokens:[]},c=d=i.current()[2],i.nextUntil(";",b),i.is(";"))&&(f=i.current(),f[2]+=k,d=f[3],f[3]+=k,e.tokens.push(f),e.sql=a.substring(c,d),e.sql&&";"!=e.sql&&g.push(e),k=-d-1,i.next()););return g}function Q(a){return r(a)?a instanceof O?a:a.map(Q).join("").trim():String(a).trim().replace(/(.*?);*?$/,"$1;")}function R(){}function S(a){return{query:function(b,c){return a.query(b,c)},getDatabase:function(b){return a.getDatabase(b,!1)},getCurrentDatabase:function(){return a.getCurrentDatabase()},getTable:function(b,c){return a.getTable(b,c,!1)},forEachRow:function(b,c){a.query(b,function(a,b){if(a)throw a;b&&b.rows&&b.rows.forEach(c)})},config:function(b,c){a.config(b,c)},on:function(b,c){return a.on(b,c)},one:function(b,c){return a.one(b,c)},off:function(b,c){return a.off(b,c),this},destroy:function(b){a.destroy(b)}}}function T(a,b){b||(b=a,a={}),s(b)&&new Ob(a).load(function(a,c){if(a)throw a;b(S(c))})}function U(a,b){var c=function(){this.name=a,this.message=g.apply(this,arguments.length?arguments:[b||"Unknown error"])};return c.prototype=new Error,c.prototype.constructor=c,c}function V(){function a(){return!1}var b={};this.bind=function(c,d){d===!1&&(d=a);var e=b[c];return e||(e=b[c]=[]),e.push(d),d},this.one=function(a,b){return b===!1&&(b=function(){return!1}),b.__one_time_listener__=!0,this.bind(a,b)},this.unbind=function(a,c){if(a)if(c)for(var d=b[a]||[],e=d.length;e--;)d[e]===c&&d.splice(e,1);else b[a]=[];else b={};return this},this.dispatch=function(a){var c,d,e,f,g=b[a]||[],h=!1,i=Array.prototype.slice.call(arguments,0),j=g.length;for(d=0;j>d;d++)if(e=g[d],f=e.apply(this,i),e.__one_time_listener__&&(g.splice(d--,1),j--),f===!1){h=!0;break}return h||(c=this.bubbleTarget,c&&(h=c.dispatch.apply(c,i)===!1)),!h},this.on=this.bind,this.off=this.unbind,this.once=this.one,this.emit=this.dispatch,this.trigger=this.dispatch}function W(a,b,c,d,e){function f(b){var c=Array.prototype.slice.call(arguments,1);c.unshift({message:b,line:p,col:q,pos:m,src:a,token:h}),k.apply({},c)}function g(){var a,c=u&&o===ob||v&&o===pb||w&&(o===lb||o===mb)||x&&o===nb&&("'"==n||'"'==n||"`"==n);c||(h=[n,o||(/^-?\d+$/.test(n)?fb:n in tb?gb:eb),r,m,s],a=b(h)),n="",o=db,r=m,a&&a!==!0?f(a):a===!1&&(m=-1)}for(var h,i,j,l,m=0,n="",o=db,p=1,q=0,r=0,s=0,t=e||{},u=!!t.skipSpace,v=!!t.skipEol,w=!!t.skipComments,x=!!t.skipStrQuots;i=a[m];){switch(l=o===hb||o===ib||o===jb||o===mb||o===lb,i){case"-":l?n+=i:"-"==a[m+1]?(n&&g(),n=i,o=lb):(o!==fb&&(a[m+1]||"").match(/[0-9]/)?(n&&g(),o=fb):o!==gb&&(n&&g(),o=gb),n+=i),m++;break;case"/":o===hb||o===ib||o===jb||o===lb?(n+=i,m++):o===mb?(n+=i,m++,"*"==a[m-2]&&n&&g()):"*"==a[m+1]?(n&&g(),n+=i,o=mb,m++):(o!==gb&&(n&&g(),o=gb),n+=i,m++);break;case"\n":p++,l&&o!==lb?(n+=i,m++,q=0):(n&&g(),o=pb,n+=i,m++,q=0,g());break;case"'":if(o===hb)a[m+1]==i?(n+=i,m+=2):(g(),n+=i,m++,o=nb,g());else if(l)n+=i,m++;else for(n&&g(),n+=i,m++,o=nb,g(),o=hb;a[m]&&"'"!=a[m]&&"'"!=a[m+1];)n+=a[m++];break;case'"':if(o===ib)a[m+1]==i?(n+=i,m+=2):(g(),n+=i,m++,o=nb,g());else if(l)n+=i,m++;else for(n&&g(),n+=i,m++,o=nb,g(),o=ib;a[m]&&'"'!=a[m]&&'"'!=a[m+1];)n+=a[m++];break;case"`":if(o===jb)a[m+1]==i?(n+=i,m+=2):(g(),n+=i,m++,o=nb,g());else if(l)n+=i,m++;else for(n&&g(),n+=i,m++,o=nb,g(),o=jb;a[m]&&"`"!=a[m]&&"`"!=a[m+1];)n+=a[m++];break;case"(":l?(n+=i,m++):(n&&g(),o=nb,n=i,m++,g(),s++,c());break;case")":l?(n+=i,m++):(n&&g(),d(),o=nb,n=i,m++,s--,g());break;case";":l?(n+=i,m++):(n&&g(),m++,o=kb,n=i,g());break;case" ":case"	":l||o===ob||(n&&g(),o=ob),n+=i,m++;break;case"!":l?(n+=i,m++):(n&&g(),o=gb,n+=i,j=a[m+1],("="==j||"<"==j||">"==j)&&(n+=j,m++),g(),m++);break;case"<":l?(n+=i,m++):(n&&g(),o=gb,n+=i,j=a[m+1],("="==j||">"==j)&&(n+=j,m++),g(),m++);break;case">":l?(n+=i,m++):(n&&g(),o=gb,n+=i,j=a[m+1],"="==j&&(n+=j,m++),g(),m++);break;case"=":case"+":case"-":case"*":case"/":case"%":l?(n+=i,m++):(n&&g(),o=gb,n+=i,m++,g());break;case".":l?n+=i:n&&/^-?\d+$/.test(n)?(o=fb,n+=i):(n&&g(),j=a[m+1],j&&/[0-9]/.test(j)?(o=fb,n+=i):(o=nb,n+=i,g())),m++;break;case",":l?n+=i:(n&&g(),o=nb,n+=i,g()),m++;break;case"\\":switch(m++,j=a[m],m++,j){case"0":n+="\x00";break;case"b":n+="\b";break;case"n":n+="\n";break;case"r":n+="\r";break;case"t":n+="	";break;case"%":n+="\\%";break;case"_":n+="\\_";break;default:n+=j}break;default:o===ob&&n&&g(),n+=i,m++}q++}if(n&&g(),o===hb)throw"Unexpected end of input. Expecting '.";if(o===ib)throw'Unexpected end of input. Expecting ".';if(o===jb)throw"Unexpected end of input. Expecting `.";if(o===mb)throw"Unexpected end of input. Expecting */.";t.addEOF&&(o=qb,g())}function X(a,b,c){this._tokens=[],this.init(a,b,c)}function Y(a){var c=B({timeout:1e3,delay:0,name:"Anonymous transaction",autoRollback:!0,debug:!1},a),d=[],e=0,f=-1,g=0,h=0,i=0,j="";V.call(this),c.debug&&(this.on("error",function(a,b){console.error(b)}),this.on("before:task",function(a,b){console.info("Starting task ",c.name,"->",b.name)}),this.one("complete",function(){console.info('Transaction complete "%s"',c.name)}));var k={onComplete:"complete",onRollback:"rollback",onError:"error",beforeTask:"before:task",afterTask:"after:task",beforeUndo:"before:undo",afterUndo:"after:undo",onProgress:"progress"};for(var l in k)s(c[l])&&this.on(k[l],c[l]);this.getLength=function(){return e},this.getWeight=function(){return i},this.setWeight=function(a){i=a},this.start=function(){if(this.isComplete())throw new Error("The transaction is already complete");if(this.isStarted())throw new Error("The transaction is already running");this.emit("start"),this.next()},this.reset=function(a){if(this.isStarted()&&!this.isComplete())throw new Error("Cannot reset a transacion while it is runing");g&&clearTimeout(g),h&&clearTimeout(h),d.splice(0,e),e=d.length,f=e-1,i=0,j="",a||this.emit("reset")},this.destroy=function(){this.reset(!0),this.off()},this.add=function(a){if(a&&a instanceof Y){var b=a;a=Y.createTask({name:"Nested transaction",execute:function(a){b.on("complete",a),b.on("error",a),b.start()},undo:function(a){b.on("rollback",function(){var c=Array.prototype.slice.call(arguments);c.unshift(null),a.apply(b,c)}),b.rollback()}}),b.parentTransaction=this,i+=b.getWeight()}else i+=a.weight||1,this.parentTransaction&&this.parentTransaction.setWeight(this.parentTransaction.getWeight()+(a.weight||1));a.transaction=this,e=d.push(a),a.name+=" (at position "+e+")"},this.rollback=function(a){function c(a){i.emit("progress",i.getProgress(),e,f+1),i.emit("after:undo",e,f+1),a&&i.emit("error",a||"Task '"+e.name+"' failed to undo"),i.rollback()}if(g&&clearTimeout(g),h&&clearTimeout(h),a===b||a===f){if(0>f)return void this.emit("rollback",j);var e=d[f--],i=this;this.emit("before:undo",e,f+1);try{e.undo(c)}catch(k){this.emit("error",k),this.rollback()}}},this.isStarted=function(){return f>-1},this.isComplete=function(){return!this.isEmpty()&&f===e-1},this.isEmpty=function(){return 0===e},this.getProgress=function(){var a,b=0;for(a=0;f>=a;a++)b+=d[a].weight||1;return b/i},this.setOption=function(a,b){return c[a]=b,this},this.getOption=function(a){return c[a]},this.next=function(a){g&&clearTimeout(g),h&&clearTimeout(h),(a===b||a===f)&&(this.isComplete()||this.isEmpty()?this.emit("complete"):!function(a,b,d){function e(e){b===f&&(e?(j=e||"Task '"+a.name+"' failed.",d.emit("error",j),c.autoRollback&&d.rollback(b)):(d.emit("progress",d.getProgress(),a,b),d.emit("after:task",a,b),c.delay?h=setTimeout(function(){d.next()},c.delay):Ib(function(){d.next()})))}var i="timeout"in a?a.timeout:c.timeout;i>0&&(g=setTimeout(function(){j="Task '"+a.name+"' timed out!.",d.emit("error",j),c.autoRollback&&d.rollback(b)},i+c.delay)),d.emit("before:task",a,b);try{a.execute(e)}catch(k){d.emit("error",k),c.autoRollback&&d.rollback(b)}}(d[++f],f,this))}}function Z(a){B(this,a)}function $(a,b,c,d){this.columns=[],this._index=[],this.setTable(a),this.setType(c),this.setName(d||b.join("_")),this.setColumns(b),this.init()}function _(a){this.data=null,this.type=_.TYPE_UNKNOWN,this.cols=[],this.rows=[],this._startTime=Date.now(),this._endTime=0,this.time=0,this.colLength=0,this.rowLength=0,arguments.length&&this.setData(a)}var ab={},bb="JSDB",cb={},db=0,eb=1,fb=2,gb=3,hb=4,ib=5,jb=6,kb=7,lb=8,mb=9,nb=10,ob=13,pb=14,qb=15,rb=[eb,ib,hb,jb],sb=[fb,ib,hb,jb],tb={ALL:1,AND:1,ANY:1,BETWEEN:1,EXISTS:1,IN:1,LIKE:1,NOT:1,OR:1,IS:1,UNIQUE:1,IF:1,"!=":1,"<>":1,">=":1,"<=":1,"!<":1,"!>":1,"=":1,">":1,"<":1,"+":1,"-":1,"*":1,"/":1,"%":1},ub=["BIT","TINYINT","SMALLINT","MEDIUMINT","INT","INTEGER","BIGINT","REAL","DOUBLE","FLOAT","DECIMAL","NUMERIC","DATE","TIME","TIMESTAMP","DATETIME","YEAR","CHAR","VARCHAR","BINARY","VARBINARY","TINYBLOB","BLOB","MEDIUMBLOB","LONGBLOB","TINYTEXT","TEXT","MEDIUMTEXT","LONGTEXT","ENUM","SET"],vb=/^[a-zA-Z\$_][a-zA-Z0-9\$_]*$/,wb=/^\s+|\s+$/,xb=new RegExp(["^","(","\\s*","(\\d{4})","-","(0[1-9]|1[0-2]|[1-9])","-","([12]\\d|0[1-9]|3[01]|[1-9])",")?","(","[tT\\s]?","([01]\\d|2[0-3])","\\:","([0-5]\\d|\\d)","(\\:","([0-5]\\d|\\d)","([\\.,](\\d+))?",")?","\\s*(","[zZ]|","(","([\\+\\-])","([01]\\d|2[0-3]|\\d)","(\\:?([0-5]\\d|\\d))?",")",")?",")?","\\s*$"].join("")),yb="%Y-%m-%dT%H:%M:%S%z",zb=1,Ab=1e3*zb,Bb=60*Ab,Cb=60*Bb,Db=24*Cb,Eb=7*Db,Fb={};Fb[db]="character",Fb[eb]="word",Fb[fb]="number",Fb[gb]="operator",Fb[hb]="string",Fb[ib]="string",Fb[jb]="string",Fb[kb]="character",Fb[lb]="comment",Fb[mb]="comment",Fb[nb]="punctoator",Fb[ob]="space",Fb[pb]="new line";var Gb=Object.prototype.toString;T.parseDate=G,T.strftime=I;var Hb={DATE:I,NOW:function(){return I("%s","now")},RAND:Math.random,ROUND:e,TRUNCATE:f,BENCHMARK:function(a,b){for(var c=Date.now(),d={BENCHMARK:null},e=0;a>e;e++)K(b,scopebv,d);return Date.now()-c}};O.prototype=[],R._super_=Function,R.extend=function rc(a,b){var c=function(){return"function"==typeof this.construct?this.construct.apply(this,arguments):void 0};return c.prototype=new this,b&&B(c,b),B(c.prototype,a),c.prototype.constructor=c,c._super_=this,c.extend=rc,c};var Ib=function(){function a(a){var b=document.createTextNode(""),c=[],d=1;return new a(function(){for(;c.length;)c.shift()()}).observe(b,{characterData:!0}),function(a){c.push(a),d=b.data=-1*d}}return"function"==typeof setImmediate?function(a){setImmediate(a)}:"function"==typeof MutationObserver?a(MutationObserver):"function"==typeof WebKitMutationObserver?a(WebKitMutationObserver):function(a){setTimeout(a,0)}}();T.nextTick=Ib;var Jb=(U("CustomError"),U("SQLParseError","Error while parsing sql query")),Kb=U("SQLRuntimeError","Error while executing sql query"),Lb=U("SQLConstraintError","SQL constraint violation");X.prototype={_pos:0,_input:"",init:function(a,b,c){this._pos=0,this._tokens=a||[],this._input=b||"",this.server=c},back:function(a){if(a=d(a||1,1),1>a)throw new Error("Invalid argument (expecting positive integer)");if(this._pos-a<0)throw new Error("The parser is trying go before the first token");return this._pos-=a,this},forward:function(a){if(a=d(a||1,1),1>a)throw new Error("Invalid argument (expecting positive integer)");if(!this._tokens[this._pos+a])throw new Error("The parser is trying go after the last token");return this._pos+=a,this},next:function(){return this._tokens[this._pos+1]?(this._pos++,this.current()):!1},prev:function(){return this._tokens[this._pos-1]?(this._pos--,this.current()):!1},current:function(){return this._tokens[this._pos]},get:function(){return this._tokens[this._pos]?this._tokens[this._pos][0]:""},is:function(a,b,c){var e,f,g,h,i=this.current(),j=i?i[0]:"";if(a.indexOf("|")>0){for(e=a.split(/\s*\|\s*/),h=0;h<e.length;h++)if(this.is(e[h],b))return c&&this._pos++,!0;return!1}if(a.indexOf("&")>0){for(f=!1,e=a.split(/&+/),h=0;h<e.length;h++)if(!this.is(e[h],b))return!1;return c&&this._pos++,!0}if(a.indexOf(" ")>0){for(f=!1,g=this._pos,e=a.split(/\s+/),h=0;h<e.length;h++){if(!this.is(e[h],b))return this._pos=g,!1;this._pos++}return c||(this._pos=g),!0}if("!"==a[0])return this.is(a.substr(1),b)?!1:(c&&this._pos++,!0);if("@"==a[0]){var k=d(a.substr(1));return i&&i[1]===k?(c&&this._pos++,!0):!1}return b?a===j?(c&&this._pos++,!0):!1:a.toUpperCase()===j.toUpperCase()?(c&&this._pos++,!0):!1},require:function(a,b){if(!this.is(a,b)){var c="the start of the query";throw this._pos>0&&(c=this._input.substring(0,this._tokens[this._pos][2]),c=c.substring(c.lastIndexOf(this.lookBack(5)[0])),c=c.replace(/[\r\n]/,"").replace(/\t/," "),c=c.replace(/\s+$/,""),c="..."+c),new Jb("You have an error after %s. Expecting %s. The query was %s",c,a,this._input)}},some:function(a,b,c){var d,e,f=this._tokens[this._pos],g=[],i=j(c);if(f){for(d in a){if(this.is(d,b,!0))return a[d].apply(this,i),this;g.push(d)}throw e="the start of the query",this._pos>0&&(e=this._input.substring(0,this._tokens[this._pos][2]),e=e.substring(e.lastIndexOf(this.lookBack(5)[0])),e=e.replace(/[\r\n]/,"").replace(/\t/," "),e=e.replace(/\s+$/,""),e="..."+e),new Jb('Expecting: %s after "%s". The query was %s',h(g),e,this._input)}return this},any:function(a,b,c){var d,e,f,g=this._tokens[this._pos];if(g)for(a="[object Array]"==Object.prototype.toString.call(a)?a:[a],d=a.length,f=0;d>f;f++)if(e=a[f],e.toUpperCase()===g[0].toUpperCase())return this._pos++,b(g),this;throw c&&c(g),new Jb("Expecting: %s. The query was %s",h(a),this._input)},pick:function(a,b,c){return this.some(a,b,c)},optional:function(a,b){var c,d=this;if(!a)return this;if("string"==typeof a){var e,f=l(a).toUpperCase().split(/\s+/),g=this.lookAhead(f.length);if(f.join(" ")===g.join(" ").toUpperCase())this._pos+=f.length,b.call(this);else{for(e=0;e<f.length&&e<g.length&&f[e]===g[e].toUpperCase();e++);if(e>0)throw new Jb('Expecting "%s" after "%s". The query was %s',f[e],g[e-1],d._input)}}else"object"==typeof a&&("[object Array]"==Object.prototype.toString.call(a)?o(a,function(b){var e=!1;return o(b,function(b,f){return c=d._pos,d.optional(f,function(){e=!0,d._tokens.splice(c,d._pos-c),d._pos=c,b(),d.optional(a)}),!e}),!e}):o(a,function(a,b){var c=!1;return this.optional(b,function(){c=!0,a()}),!c},this));return this},someType:function(a,b,c){var d,e,f=this._tokens[this._pos],g=[];if(f){for(d in a){if(a[d]===f[1])return this._pos++,b(f),this;e=Fb[a[d]],-1==g.indexOf(e)&&g.push(Fb[a[d]])}throw new Jb("Expecting: %s %s. The query was %s",h(g),c||"",this._input)}return this},lookAhead:function(a){var b,c=[],d=this._pos,e=d+a;for(d=this._pos;e>d;d++)b=this._tokens[d],b&&c.push(b[0]);return c},lookBack:function(a){var b,c,d=[],e=this._pos-Math.abs(a);for(b=this._pos-1;b>=e&&b>=0;b--)c=this._tokens[b],c&&d.unshift(c[0]);return d},nextUntil:function(a,b,c){for(var d=this.current(),e=d?d[4]:-1;(!this.is(a)||c&&this.current()[4]!==e)&&(b&&b.call(this,this.current()),this.next()););return this},errorUntil:function(a){return this.nextUntil(a,function(a){throw new Jb('Unexpected %s "%s". The query was %s',Fb[a[1]],a[0],this._input)})},commit:function(a){var b=this._tokens[this._pos];return b&&";"==b[0]&&(this._pos++,a()),this},literalValue:function(a){var b=this._tokens[this._pos],c=sb,d=["NULL","CURRENT_TIME","CURRENT_DATE","CURRENT_TIMESTAMP"],e=["number","string","NULL","CURRENT_TIME","CURRENT_DATE","CURRENT_TIMESTAMP"];if(d.indexOf(b[0])>-1)return this._pos++,a&&a.call(this,b),this;if(c.indexOf(b[1])>-1)return this._pos++,a&&a.call(this,b),this;throw new Jb('Unexpected %s "%s". Expecting %s. The query was %s',Fb[b[1]],b[0],h(e),this._input)},commaSeparatedList:function(a){var b=this._tokens[this._pos],c=this;if(","==b[0])throw new Jb('Unexpected ",". The query was %s',this._input);return this._pos++,a.call(this,b),this.optional({",":function(){c.commaSeparatedList(a)}}),this},commaSeparatedBlock:function(a,b){var c=this,d=this._pos;return this.pick({"(":function(){var e=c._tokens[c._pos];if(","==e[0])throw new Jb('Unexpected ",". The query was %s',c._input);if(c.commaSeparatedList(a),e=c._tokens[c._pos++],")"!=e[0]){var f="";throw d>0&&(f=c._input.substring(c._tokens[d][2],c._tokens[c._pos][2]),f=f.replace(/\n/,"")),new Jb('Expecting ")" after %s. The query was %s',f||"the start of the query",c._input)}b&&b.call(c)}}),this}},Y.createTask=function(a){return new Z(a)},Z.prototype={name:"Anonymous task",execute:function(a){console.warn("The 'execute' method for task '"+this.name+"' is not implemented!"),a()},undo:function(a){console.warn("The 'undo' method for task '"+this.name+"' is not implemented!"),a()}},X.prototype.walkOnConflictClause=function(a){var b=null,c=this;return c.optional({"ON CONFLICT":function(){c.pick({"ROLLBACK|ABORT|FAIL|IGNORE|REPLACE":function(){b=this.prev()[0].toUpperCase()}})}}),a&&a.call(c,b),c},X.prototype.walkIndexedColumn=function(a){var b={},c=this;return this.someType(rb,function(a){b.name=a[0]}).optional({COLLATE:function(){c.someType(rb,function(a){b.collation=a[0]})}}).optional({ASC:function(){b.sortOrder="ASC"},DESC:function(){b.sortOrder="DESC"}}),a&&a.call(this,b),this},ab.USE=function(a){function b(b){c?(a.server.setCurrentDatabase(c.name),b(null,'Current database restored to "'+c.name+'".')):b()}var c=a.server.getCurrentDatabase();return new Z({name:"Use Database",execute:function(b){var d;a.someType(rb,function(a){d=a[0]}).errorUntil(";").commit(function(){var e=null,f=null;try{a.server.setCurrentDatabase(d),c=a.server.getCurrentDatabase(),f='Database "'+d+'" selected.'}catch(g){e=g}b(e,f)})},undo:b})},ab.SHOW_DATABASES=function(a){return new Z({name:"Show databases",execute:function(b){a.errorUntil(";").commit(function(){b(null,{cols:["Databases"],rows:p(a.server.databases).map(j)})})},undo:function(a){a()}})},ab.SHOW_TABLES=function(a){return new Z({name:"Show tables",execute:function(b){var c,d=a.server.getCurrentDatabase();a.is("FROM|IN")&&(a.forward(),a.someType(rb,function(b){c=b[0],d=a.server.databases[c]})),a.nextUntil(";").commit(function(){d?b(null,{cols:['Tables in database "'+d.name+'"'],rows:p(d.tables).map(j)}):c?b(new Kb('No such database "%s"',c),null):b(new Kb("No database selected"),null)})},undo:function(a){a()}})},ab.SHOW_COLUMNS=function(a){function c(a){var b=[];return a.unsigned&&b.push("UNSIGNED"),a.zerofill&&b.push("ZEROFILL"),a.autoIncrement&&b.push("AUTO INCREMENT"),b.join(", ")}return new Z({name:"Show columns",execute:function(d){var e,f;a.pick({"FROM|IN":function(){a.someType(rb,function(a){f=a[0]})}}),a.is("FROM|IN")&&a.forward().someType(rb,function(a){e=a[0]}),a.nextUntil(";"),a.commit(function(){var g,h=e?a.server.databases[e]:a.server.getCurrentDatabase();if(!h)return e?d(new Kb('No such database "%s"',e),null):d(new Kb("No database selected"),null);if(g=h.tables[f],!g)return d(new Kb('No such table "%s" in databse "%s"',f,h.name),null);var j={cols:["Field","Type","Null","Key","Default","Extra"],rows:[]};n(g.cols,function(a){var d=a.toJSON();j.rows.push([d.name,a.typeToSQL(),d.nullable?"YES":"NO",d.key,"string"==typeof d.defaultValue?i(d.defaultValue,"'"):d.defaultValue===b?"none":d.defaultValue,c(d)])}),d(null,j)})},undo:function(a){a()}})},ab.CREATE_DATABASE=function(a){function b(b){c?a.server.dropDatabase(c,!0,b):b()}var c;return new Z({name:"Create Database",execute:function(b){var d=!1,e="";c=null,a.optional("IF NOT EXISTS",function(){d=!0}).someType(rb,function(a){e=a[0]}).nextUntil(";").commit(function(){c=e,a.server.createDatabase(e,d,function(a){b(a,a?null:'Database "'+e+'" created.')})})},undo:b})},ab.CREATE_TABLE=function(a){function b(b){if(g){var c=a.server.getCurrentDatabase();if(c){var d=c.tables[g];if(d)return b("Droping tables is not fully implemented yet!")}b()}else b()}function c(b){a.someType(sb,function(a){b.params.push(a[0])}),a.pick({",":function(){c(b)},")":q})}function d(b){if(!b.name)try{a.someType(rb,function(a){b.name=a[0]})}catch(c){}a.commaSeparatedBlock(function(a){b.columns.push(a[0])}),a.walkOnConflictClause(function(a){b.onConflict=a})}function e(b){var c={};a.optional("CONSTRAINT",function(){a.someType(rb,function(a){c.name=a[0]},"for the name of the constraint")}),a.pick({"KEY|INDEX":function(){c.type=$.TYPE_INDEX,c.columns=[],d(c)},"PRIMARY KEY":function(){c.type=$.TYPE_PRIMARY,c.columns=[],d(c)},UNIQUE:function(){c.type=$.TYPE_UNIQUE,c.columns=[],d(c)},CHECK:function(){c.type="CHECK"},"FOREIGN KEY":function(){c.type="FOREIGN KEY",c.columns=[],a.commaSeparatedBlock(function(a){c.columns.push(a[0])})}}),b.constraints.push(c),a.optional({",":function(){e(b)}})}function f(b){var d={};a.someType(rb,function(g){if(g[1]===eb&&g[0].match(/^(CONSTRAINT|KEY|PRIMARY|UNIQUE|CHECK|FOREIGN)$/i)){if(!b.columns.length)throw new Jb("You have to define some table columns bore defining a table constraint.");a.back(),e(b)}else d.name=g[0],a.any(ub,function(b){var e={name:b[0],params:[]};a.optional("(",function(){c(e)}),d.type=e,a.optional([{"NOT NULL":function(){d.nullable=!1},NULL:function(){d.nullable=!0}},{AUTO_INCREMENT:function(){d.autoIncrement=!0}},{KEY:function(){d.key="INDEX"},INDEX:function(){d.key="INDEX"},UNIQUE:function(){a.optional({KEY:q}),d.key="UNIQUE"},"PRIMARY KEY":function(){d.key="PRIMARY"}},{ZEROFILL:function(){d.zerofill=!0}},{UNSIGNED:function(){d.unsigned=!0}},{DEFAULT:function(){a.someType(rb,function(a){d.defaultValue=a[0]})}}])},function(){throw new Jb('Expecting data type for column "%s" (%s).',d.name,h(ub))}).pick({",":function(){b.columns.push(d),f(b)},")":function(){b.columns.push(d)}})})}var g;return new Z({name:"Create Table",execute:function(b){var c={name:"",temporary:"TEMPORARY"==a.lookBack(2)[0].toUpperCase(),ifNotExists:!1,columns:[],constraints:[]};g=null,a.optional("IF NOT EXISTS",function(){c.ifNotExists=!0}).someType(rb,function(a){c.name=a[0]}).optional("(",function(){f(c)}).nextUntil(";").commit(function(){var d=a.server.getCurrentDatabase();return d?(g=c.name,void d.createTable({name:c.name,fields:c.columns,ifNotExists:c.ifNotExists,constraints:c.constraints},function(a){b(a||null,a?null:'Table "'+c.name+'" created')})):b(new Kb("No database selected"),null)})},undo:b})},ab.DROP_DATABASE=function(a){return new Z({name:"Drop Database",execute:function(b){var c={};a.optional("IF EXISTS",function(){c.ifExists=!0}).someType(rb,function(a){c.name=a[0]},"for the database name").errorUntil(";").commit(function(){a.server.dropDatabase(c.name,c.ifExists,function(a){b(a,a?null:'Database "'+c.name+'" deleted.')})})},undo:function(a){a("undo is not implemented for the DROP DATABASE queries")}})},ab.DROP_TABLE=function(a){var b,c,d=!1;return new Z({name:"Drop Table",execute:function(e){a.optional("IF EXISTS",function(){d=!0}).someType(rb,function(a){b=a[0]}).optional(".",function(){a.someType(rb,function(a){c=b,b=a[0]})}).optional("RESTRICT|CASCADE",function(){}).errorUntil(";").commit(function(){var f=a.server.getDatabase(c),g=f.getTable(b,!d);return g?void g.drop(function(a){return a?e(a,null):void e(null,'Table "'+f.name+"."+g.name+'" deleted.')}):e(null,null)})},undo:function(a){a(null,"undo is not implemented for the DROP TABLE queries")}})},ab.INSERT=function(a){function b(c){c||(j=[]),a.someType(rb,function(a){j.push(a[0])}).pick({",":function(){b(!0)},")":q})}function c(b){a.literalValue(function(a){var c=a[0];a[1]===eb&&(c=c.toUpperCase(),"NULL"==c&&(c=null)),b.push(c)}).optional({",":function(){c(b)}})}function d(){a.pick({"(":function(){var b=[];c(b),a.pick({")":function(){var a=j.length,c=b.length;if(a!==c)throw new Jb("The number of inserted values (%s) must match the number of used columns (%s)",c,a);k.push(b)}})}}).optional({",":d})}var e,f,g,h,i,j,k=[];return new Z({name:"Insert Query",execute:function(c){a.optional({OR:function(){a.pick({REPLACE:function(){i="REPLACE"},ROLLBACK:function(){i="ROLLBACK"
},ABORT:function(){i="ABORT"},FAIL:function(){i="FAIL"},IGNORE:function(){i="IGNORE"}})}}).pick({INTO:q}).someType(rb,function(a){g=a[0]}).optional(".",function(){a.someType(rb,function(a){e=g,g=a[0]})}),f=a.server.getDatabase(e),h=f.getTable(g),j=p(h.cols),a.optional({"(":b}).pick({VALUES:d});try{a.errorUntil(";")}catch(l){return c(l,null)}a.commit(function(){h.insert(j,k,function(a){c(a,a?null:k.length+" rows inserted")})})},undo:function(a){a("undo not implemented for INSERT queries!")}})},ab.SELECT=function(a){function b(b){b=b||{};var c={database:null,table:null,field:null,isExpr:!0},e=n,f=a.current()[2],g=a.current()[3];b.allowAll&&(e+="|*"),b.allowIndexes&&(e+="|@"+fb),b.includeAlias&&(c.alias=null);do{if(!a.is(e))break;if(c.field=a.get(),a.forward(),a.is(".")){if(a.forward(),!a.is(e))break;if(c.table=c.field,c.field=a.get(),a.forward(),b.includeDB&&a.is(".")){if(a.forward(),!a.is(e))break;c.database=c.table,c.table=c.field,c.field=a.get(),a.forward()}}if(t(c.field)){if(c.field=d(c.field),c.field<0)throw new Jb("Negative column index is not allowed.")}else if(!c.field)throw new Jb("Expecting a field name");if("*"==c.table)throw new Jb('You cannot use "*" as table name');if(t(c.table))throw new Jb("You cannot use number as table name");if("*"==c.database)throw new Jb('You cannot use "*" as database name');if(t(c.database))throw new Jb("You cannot use number as database name");c.isExpr=!1}while(0);return a.nextUntil(",|AS|FROM|WHERE|GROUP|ORDER|LIMIT|OFFSET|;",function(a){g=a[3],c.isExpr=!0},!0),c.isExpr&&(c.field=a._input.substring(f,g)),b.includeAlias&&a.is(n)&&(a.is("AS")?(a.forward(),a.someType(rb,function(a){c.alias=a[0]})):a.is("FROM|WHERE|GROUP|ORDER|LIMIT|OFFSET")||(c.alias=a.current()[0],a.forward())),c}function c(){var b={database:null,table:null,alias:null};return a.someType(rb,function(a){b.table=a[0]},"for table name").optional(".",function(){a.someType(rb,function(a){b.database=b.table,b.table=a[0]},"for table name")}),a.is(n)&&(a.is("AS")?(a.forward(),a.someType(rb,function(a){b.alias=a[0]},"for table alias")):a.is("WHERE|GROUP|ORDER|LIMIT|OFFSET")||(b.alias=a.current()[0],a.forward())),b}function e(c){var d=b({includeAlias:!0,allowAll:!0,allowIndexes:!1,includeDB:!0});c.push(d),a.is(",")&&(a.forward(),e(c))}function f(b){var d=c();b.push(d),a.is(",")&&(a.forward(),f(b))}function g(){var b=[],c={expression:[],direction:"ASC"};return a.nextUntil("ASC|DESC|,|LIMIT|OFFSET|;",function(a){c.expression.push(a[0])}),c.expression=c.expression.join(" "),a.is("ASC|DESC")&&(c.direction=a.get().toUpperCase(),a.forward()),b.push(c),a.is(",")&&(a.forward(),b=b.concat(g())),b}function h(){var b=[];return a.is("ORDER BY")&&(a.forward(2),b=g()),b}function i(){var b=0,c=0;if(a.is("LIMIT")){if(a.forward(),!a.is("@"+fb))throw new Jb("Expecting a number for the LIMIT clause");if(b=d(a.get()),a.forward(),a.is(",")){if(!a.forward().is("@"+fb))throw new Jb("Expecting a number for the offset part of the LIMIT clause");c=d(a.get()),a.forward()}}if(a.is("OFFSET")){if(a.forward(),!a.is("@"+fb))throw new Jb("Expecting a number for the OFFSET clause");c=d(a.get()),a.forward()}return{limit:b,offset:c}}function j(){var b=0,c=0;return a.is("WHERE")&&(a.forward(),b=a.current()[2],c=b,a.nextUntil("GROUP|ORDER|LIMIT|OFFSET|;"),c=a.current()[2]),a._input.substring(b,c)}function k(b){var c,d=b.tables.length,e={};for(c=0;d>c;c++)e[c]=a.server.getDatabase(b.tables[c].database).getTable(b.tables[c].table),b.tables[c].alias&&(e[b.tables[c].alias]=e[c]);return e}function l(){var b,c,d,e,f,g,h={};for(b in a.server.databases){g=a.server.databases[b],h[b]={};for(c in g.tables){e=g.tables[c],h[b][c]={};for(d in e.cols)f=e.cols[d],h[b][c][d]=f}}return h}function m(b){function c(b,c){var d={database:b.database,table:b.table,colIndex:c,value:null,name:b.field,alias:b.alias,isExpr:b.isExpr};b.table&&(f=a.server.getDatabase(b.table.database).getTable(b.table.table),y.hasOwnProperty(f.name)||(y[f.name]={name:f.name}),d.table=y[f.name],x.hasOwnProperty(f._db.name)||(x[f._db.name]={}),y[f.name].database=x[f._db.name],x[f._db.name][f.name]=d.table,d.database=x[f._db.name]),r[b.field]=null,b.alias&&(r[b.alias]=null),z[c]=z[b.field]=d,b.alias&&(z[b.alias]=d),t.push(d.alias||d.name)}var d,e,f,g,h,i,j,m,n,o,p,q,r=l(),s=[],t=[],u=k(b),v=b.tables.length,w=b.fields.length,x={},y={},z={};for(n=0,m=0;w>m;m++)if(j=b.fields[m],"*"==j.field)if(j.table){f=a.server.getDatabase(j.database).getTable(j.table);for(e in f.cols)c({field:e,alias:null,table:{table:f.name,database:f._db.name},database:f._db.name,isExpr:!1},n++)}else for(p=0;v>p;p++){f=u[p];for(e in f.cols)c({field:e,alias:null,table:{table:f.name,database:f._db.name},database:f._db.name,isExpr:!1},n++)}else{if(!j.isExpr&&!j.table){if(1!==v)throw new Jb('The column "%s" needs to have it\'s table specified',j.field);j.table=b.tables[0]}c(j,n++)}z.__length__=n;var A,B=[];for(m=0;v>m;m++){A=[],f=u[m];for(g in f.rows)A.push(f.rows[g].toJSON("object"));B.push(A)}for(m=0;w>m;m++)j=b.fields[m],j.isExpr&&(i={},i[j.alias||j.field]=j.field.replace(/^\s*\((.*?)(\)\s*$)/,"$1"),B.push([i]));s=L(B),b.orderBy&&s.sort(function(a,c){var d,e,f,g,h,i=0;for(g=0;g<b.orderBy.length&&(h=b.orderBy[g],d=h.expression,e=a[d],f=c[d],e>f?i+="ASC"==h.direction?1:-1:f>e&&(i+="ASC"==h.direction?-1:1),0===i);g++);return i});var C=b.bounds.limit,D=b.bounds.offset,E=s.length;for(0>D&&(D=E+D),o=s.length,m=0;o>m;m++){h=s[m];for(d in h)q=z[d],q&&q.isExpr&&(h[d]=K(h[d],h))}var F=[];for(m=0;o>m;m++)if(!(D>m||C&&m>=D+C||(h=s[m],b.where&&!K(b.where,h)))){for(d in h)q=z[d],(!q||q.alias&&q.alias!==d)&&delete h[d];F.push(h)}return{cols:t,rows:F}}var n=["@"+eb,"@"+hb,"@"+ib,"@"+jb].join("|");return new Z({name:"SELECT Query",execute:function(b){var c={fields:[],tables:[]};e(c.fields),a.optional({FROM:function(){f(c.tables)}}),c.where=j(),c.orderBy=h(),c.bounds=i(),a.errorUntil(";").commit(function(){var a=m(c);b(null,{cols:a.cols,rows:a.rows})})},undo:function(a){a()}})},ab.DELETE=function(a){return new Z({name:"Delete Query",execute:function(b){var c,d,e=0,f=0,g="",h=["@"+eb,"@"+hb,"@"+ib,"@"+jb].join("|");if(a.require("FROM"),!a.forward().is(h))throw new Jb('Expecting an identifier for table name before "%s"',a.get());if(c=a.get(),a.forward().is(".")){if(!a.forward().is(h))throw new Jb("Expecting an identifier for table name after %s.",c);d=c,c=a.get(),a.forward()}a.is("WHERE")?(a.forward(),e=a.current()[2],f=e,a.nextUntil(";"),f=a.current()[3],g=a._input.substring(e,f)):a.errorUntil(";"),a.commit(function(){var e,f,h=d?a.server.getDatabase(d):a.server.getCurrentDatabase(),i=[],j=0;if(!h)throw d?new Kb("No such database '%s'",d):new Kb("No database selected");e=h.getTable(c),f=e.rows,n(f,function(a){(!g||K(g,a.toJSON("mixed")))&&(j=i.push(a))}),j?e.deleteRows(i,function(a){b(a,a?null:j+" rows deleted")}):b(null,j+" rows deleted")})},undo:function(b){a.server.options.debug&&console.warn("undo not implemented for DELETE queries!"),b()}})},ab.UPDATE=function(a){function b(a){var b="ABORT";return a.is("OR")&&(a.forward().require("ROLLBACK|ABORT|REPLACE|FAIL|IGNORE"),b=a.get().toUpperCase(),a.forward()),b}function c(a){var b,c,d;if(!a.is(f))throw new Jb('Expecting a table identifier before "%s"',a.get());if(b=a.get(),a.forward().is(".")){if(!a.forward().is(f))throw new Jb("Expecting an identifier for table name after %s.",b);c=b,b=a.get(),a.forward()}if(d=c?a.server.getDatabase(c):a.server.getCurrentDatabase(),!d)throw c?new Kb("No such database '%s'",c):new Kb("No database selected");return d.getTable(b)}function d(a){var b,c,d="";return a.is("WHERE")&&(a.forward(),b=a.current()[2],c=b,a.nextUntil(";"),c=a.current()[2],d=a._input.substring(b,c)),d}function e(a){function b(){var d,e,g,h;if(!a.is(f))throw new Jb('Expecting a column identifier before "%s"',a.get());d=a.get(),a.forward(),a.require("="),g=a.current()[3],a.forward(),h=g,a.nextUntil(",|WHERE|;"),h=a.current()[2],e=l(a._input.substring(g,h)),c[d]=e,a.is(",")&&(a.forward(),b())}var c={};return a.require("SET"),a.forward(),b(),c}var f=["@"+eb,"@"+hb,"@"+ib,"@"+jb].join("|");return new Z({name:"Update Table",execute:function(f){var g=b(a),h=c(a),i=e(a),j=d(a);a.errorUntil(";").commit(function(){h.update(i,g,j,function(){f(null,"DONE")},function(a){f(a,null)})})},undo:function(b){a.server.options.debug&&console.warn("undo is not implemented for UPDATE queries yet!"),b()}})},ab.BEGIN=function(a){return new Z({name:"Begin transaction",execute:function(b){var c="DEFERRED";a.is("DEFERRED|IMEDDIATE|EXCLUSIVE")&&(c=a.get().toUpperCase(),a.forward()),a.is("TRANSACTION")&&a.forward(),a.errorUntil(";"),a.commit(function(){a.server.beginTransaction({type:c}),b(null,"Transaction created")})},undo:function(b){a.server.rollbackTransaction(b)}})},ab.COMMIT=function(a){return new Z({name:"Commit transaction",execute:function(b){a.is("TRANSACTION")&&a.forward(),a.errorUntil(";"),a.commit(function(){a.server.commitTransaction(),b()})},undo:function(b){a.server.rollbackTransaction(b)}})},ab.ROLLBACK=function(a){return new Z({name:"Rollback transaction",execute:function(b){a.is("TRANSACTION")&&a.forward(),a.errorUntil(";"),a.commit(function(){a.server.rollbackTransaction(),b()})},undo:function(b){a.server.commitTransaction(),b()}})},ab.SOURCE=function(a){return new Z({name:"SOURCE Command",execute:function(b){var c,d,e,f=a.current()[2],h=["@"+hb,"@"+ib,"@"+jb].join("|");a.is(h)?(e=a.get().trim(),a.forward().errorUntil(";")):(f=a.current()[2],a.nextUntil(";"),d=a.current()[2],e=a._input.substring(f,d).trim()),a.commit(function(){return e?(c=new XMLHttpRequest,c.open("GET",e,!0),c.onreadystatechange=function(){if(4==c.readyState)if(200==c.status||304==c.status){var d=P(c.responseText),f=d.length;a.server.query(d,function(c,h,i){return c?b(c?c:new Kb("Error executing query:\n%s",d[i].sql),null):void(i===f-1&&a.server.save(function(a){b(a,a?null:g('%s queries executed successfuly from file "%s"',f,e))}))})}else b(new Kb(c.statusText),null)},void c.send(null)):b(new Jb("No path specified"),null)})},undo:function(b){a.server.options.debug&&console.warn("The SOURCE command cannot be undone!"),b("The SOURCE command cannot be undone!")}})};var Mb=function(){function a(){var a={};return n(d,function(b,c){a[c]=b.label||c}),a}function b(a,b,c){if(d[a])throw new Error('Storage engine "'+a+'" is already registered.');return d[a]=g.extend(b,c),d[a]}function c(a,b){var c,f=e[a.type];if(f)b(null,f);else{if(c=d[a.type],!c)throw new Error('No such ttorage engine "'+a.type+'".');f=new c(a),f.load(function(c){return c?b(c,null):(e[a.type]=f,void b(null,f))})}}var d={},e={},f={};n(["set","get","unset","setMany","getMany","unsetMany"],function(a){var b=arguments[arguments.length-1];b=s(b)?b:function(a){throw a},f[a]=function(){b('Action "'+a+'" failed. Method not implemented.')}}),f.load=function(a){a(null,this)};var g=R.extend(f);return T.getStorageEngine=c,T.registerStorageEngine=b,T.getRegisteredStorageEngines=a,{getEngine:c,registerEngine:b}}();!function(){function a(a){for(var b in a)localStorage.setItem(b,JSON.stringify(a[b]))}function b(a){for(var b=[],c=0,d=a.length;d>c;c++)b.push(JSON.parse(localStorage.getItem(a[c])));return b}function c(a){for(var b=0,c=a.length;c>b;b++)localStorage.removeItem(a[b])}function d(a,b){localStorage.setItem(a,JSON.stringify(b))}function e(a){return JSON.parse(localStorage.getItem(a))}function f(a){localStorage.removeItem(a)}T.registerStorageEngine("LocalStorage",{construct:function(){if(!window.localStorage||!s(localStorage.setItem))throw new Error("localStorage is not supported")},setMany:function(b,c){Ib(function(){var d=null;try{a(b)}catch(e){d=e}c(d)})},getMany:function(a,c){Ib(function(){var d=null,e=[];try{e=b(a)}catch(f){d=f}c(d,e)})},unsetMany:function(a,b){Ib(function(){var d=null;try{c(a)}catch(e){d=e}b(d)})},set:function(a,b,c){Ib(function(){var e=null;try{d(a,b)}catch(f){e=f}c(e)})},get:function(a,b){Ib(function(){var c,d=null;try{c=e(a)}catch(f){d=f}b(d,c)})},unset:function(a,b){Ib(function(){var c=null;try{f(a)}catch(d){c=d}b(c)})}},{label:"Local Storage"})}();var Nb=R.extend({construct:function(a,b){this.label=a||"persistable",this.storage=b?b.storage:null,this._isDirty=!1,this.children={},this.parent=b||null,this.bubbleTarget=this.parent,V.call(this)},toJSON:function(){throw"Please implement the 'toJSON' method to return the JSON representation of the instance"},getStorageKey:function(){throw"Please implement the 'getStorageKey' method to return the storage key"},getPatch:function(){var a,b,c,d=!1,e={};this._isDirty&&(d=!0,e[this.getStorageKey()]=JSON.stringify(this.toJSON()));for(a in this.children)b=this.children[a],c=b.getPatch(),c&&(d=!0,B(e,c));return d?e:null},read:function(a){this.storage.get(this.getStorageKey(),function(b,c){a(b,b?null:c)})},write:function(a,b){this.storage.set(this.getStorageKey(),a,b)},drop:function(a){this.storage.unset(this.getStorageKey(),a)},save:function(a){var b=this,c=A(a),d=b.getPatch();return d?(b.emit("savestart:"+b.label,b),void(b.parent?b.parent.save(b.onSave(c)):b.storage.setMany(d,b.onSave(c)))):c(null,b)},onSave:function(a){var b=this;return function(c){return c?a(c,b):(b._isDirty=!1,b.emit("save:"+b.label,b),void a(null,b))}},load:function(a){this.read(a)}}),Ob=Nb.extend({construct:function(a){Nb.prototype.construct.call(this,"server"),this._transaction=null,this.databases={},this.options={},this._queryTasks={},this.config(B({debug:!1,storageEngine:{type:"LocalStorage"}},a)),this.children=this.databases,this._init()},destroy:function(){this.off(),this._destroyTransaction(),this.children=this.databases={},this.options={},this._queryTasks={}},config:function(a,b){var c=arguments.length;return c?1===c?a&&"object"==typeof a?(B(this.options,a),this):this.options[a]:(this.options[a]=b,this):this.options},isInTransaction:function(){return!!this._transaction},getTransaction:function(){return this._transaction||null},_destroyTransaction:function(){this._transaction&&(this._transaction.destroy(),this._transaction=null)},beginTransaction:function(a){if(this.isInTransaction())throw new Kb("There is a current transaction already started");this._transaction=new Y(B({debug:this.options.debug},a));var b=this;return this._transaction.on("rollback",function(){b._destroyTransaction()}),this._transaction.on("complete",function(){b._destroyTransaction()}),this._transaction},commitTransaction:function(){if(!this.isInTransaction())throw new Kb("There is no current transaction");this._transaction.start()},rollbackTransaction:function(a){this._transaction||a(new Kb("There is no current transaction")),a&&this._transaction.one("rollback",function(){a()}),this._transaction.rollback()},getStorageKey:function(){return bb},toJSON:function(){var a={databases:{}};for(var b in this.databases)a.databases[b]=this.databases[b].getStorageKey();return a},load:function(a){function b(a){d.add(Y.createTask({name:"Load Database '"+a+"'",execute:function(b){var d=new Pb(a,c);c.databases[d.name]=d,d.load(b)},undo:function(a){a(null)}}))}var c=this,d=new Y({name:"Load Server",timeout:1e4,debug:!!this.options.debug}),e=A(a);return d.on("complete",function(){c.loaded=!0,c.emit("load:server",c),e(null,c)}),d.on("rollback",function(a,b){e(b,null)}),d.add(Y.createTask({name:"Load Server Storage",execute:function(a){Mb.getEngine(c.options.storageEngine,function(b,d){return b?a(b,null):(c.storage=d,void a(null,d))})}})),d.add(Y.createTask({name:"Load Server",timeout:1e4,execute:function(a){c.read(function(d,e){if(d)return a(d,c);if(c.children=c.databases={},!e||!e.databases)return a(null,c);for(var f in e.databases)b(f);return c._isDirty=!1,a(null,c)})}})),c.emit("loadstart:server",c),d.start(),c},createDatabase:function(a,b,c){var d=A(c),e=this;if("string"!=typeof a)return d(new Kb("Invalid database name"),null);if(!a)return d(new Kb("No database name"),null);if(e.databases.hasOwnProperty(a))return b?d(null,e.databases[a]):d(new Kb('Database "'+a+'" already exists'),null);var f=new Pb(a,e);e.databases[a]=f,e._isDirty=!0,this.save(function(b){return b?(delete e.databases[a],d(b,f)):void d(null,f)})},dropDatabase:function(a,b,c){var d,e,f,g,h,i=A(c),j=this,k=j.databases[a];if(!k)return i(b?null:new Kb('Database "'+a+'" does not exist'),j);h=[k.getStorageKey()];for(d in k.tables){e=k.tables[d],g=e.getStorageKey(),h.push(g);for(f in e.rows)h.push(g+"."+f)}j._isDirty=!0,j.storage.unsetMany(h,function(b){return b?i(b,j):(j.currentDatabase===k&&(j.currentDatabase=null),delete j.databases[a],void j.save(function(a){i(a,j)}))})},getDatabase:function(a,b){var c;if(a){if(c=this.databases[a],!c){if(b===!1)return null;throw new Kb('No such database "%s"',a)}}else if(c=this.currentDatabase,!c){if(b===!1)return null;throw new Kb("No database selected.")}return c},setCurrentDatabase:function(a){var b=l(a);if(!this.databases.hasOwnProperty(b))throw new Kb('No such database "%s".',b);return this.currentDatabase=this.databases[b],this},getCurrentDatabase:function(){return this.currentDatabase||null},getTable:function(a,b,c){var d,e=this.getDatabase(b,c);if(!e)return null;if(d=e.tables[a],!d){if(c===!1)return null;throw new Kb('No such table "%s" in database "%s"',a,e.name)}return d},_init:function(){var a=this;n({"SHOW DATABASES":"SHOW_DATABASES","SHOW SCHEMAS":"SHOW_DATABASES","SHOW TABLES":"SHOW_TABLES","SHOW COLUMNS":"SHOW_COLUMNS","CREATE DATABASE":"CREATE_DATABASE","CREATE SCHEMA":"CREATE_DATABASE","CREATE TABLE":"CREATE_TABLE","CREATE TEMPORARY TABLE":"CREATE_TABLE","DROP DATABASE":"DROP_DATABASE","DROP SCHEMA":"DROP_DATABASE","DROP TABLE":"DROP_TABLE","DROP TEMPORARY TABLE":"DROP_TABLE",SELECT:"SELECT",USE:"USE",UPDATE:"UPDATE",INSERT:"INSERT",DELETE:"DELETE",SOURCE:"SOURCE",BEGIN:"BEGIN"},function(a,b){this._queryTasks[b]=this._createQueryTask(a)},this),this._queryTasks.COMMIT=this._queryTasks.END=function(b,c){var d,e=a.getTransaction(),f=this;return e?(d=new _,void(e.isEmpty()?(ab.COMMIT(f).execute(q),d.setData("Empty transaction committed"),c(null,d,b)):(d.setData("Transaction committed"),c(null,d,b),e.one("complete",function(){d.setData("Transaction complete"),c(null,d,b)}),e.one("rollback",function(a,d){c(new Kb("Transaction rolled back!"+(d?"\n"+d:"")),null,b)}),ab.COMMIT(f).execute(q)))):c(new Kb("There is no transaction to commit"),null,b)},this._queryTasks.ROLLBACK=function(b,c){var d,e=a.getTransaction(),f=this;return e?(d=new _,void(e.isEmpty()?(ab.ROLLBACK(f).execute(q),d.setData("Empty transaction rolled back"),c(null,d,b)):(e.one("rollback",function(){d.setData("Transaction rolled back!"),c(null,d,b)}),ab.ROLLBACK(f).execute(q)))):c(new Kb("There is no transaction to rollback"),null,b)}},_handleQuery:function(a,b,c,d){var e=a[b],f=this;if(e){this.options.debug&&console.info("Query: ",e.sql);try{new X(e.tokens,e.sql,this).pick(this._queryTasks,!1,[b,function(e,g,h){c(e,g,h,d),e||f._handleQuery(a,b+1,c,d)}])}catch(g){c(g,null,b,d)}}},_createQueryTask:function(a){var b=this;return function(c,d){var e,f=ab[a],g=b.getTransaction(),h=new _,i=this;g?(e=f(i),g.add(Y.createTask({name:a,execute:function(a){var b=new _;e.execute(function(f,g){f?e.undo(function(){a(f)}):(b.setData(g),d(null,b,c),a())})},undo:function(a){e.undo(function(){a()})}})),h.setData(a+" query added to the transaction"),d(null,h,c)):(e=f(i),e.execute(function(a,b){return a?e.undo(function(){d(a,null,c)}):(h.setData(b),void d(null,h,c))}))}},query:function(a,b){var c,d;try{c=a instanceof O?a:P(a)}catch(e){return b(e,null,-1,0)}return(d=c.length)?void this._handleQuery(c,0,b,d):b(null,new _("No queries executed"))}}),Pb=Nb.extend({construct:function(a,b){Nb.prototype.construct.call(this,"database"),this.tables={},this.name=a,this.parent=this.server=b,this.storage=b.storage,this.bubbleTarget=b,this.children=this.tables},toJSON:function(){var a,b={name:this.name,tables:{}};for(a in this.tables)b.tables[a]=[bb,this.name,a].join(".");return b},getStorageKey:function(){return bb+"."+this.name},drop:function(a){function b(a){f.add(Y.createTask({name:'Drop Table "'+a.name+'"',execute:function(b){delete e.tables[a.name],a.drop(b)},undo:function(b){e.tables[a.name]=a,b()}}))}var c,d=A(a),e=this,f=new Y({name:"Drop Database"});f.one("complete",function(){d(null,e)}),f.one("rollback",function(a){d(a,e)});for(c in e.tables)b(e.tables[c]);f.add(Y.createTask({name:'Drop Database "'+e.name+'"',execute:function(a){delete e.server.databases[e.name],Nb.prototype.drop.call(e,a)},undo:function(a){e.server.databases[e.name]=e,a()}})),f.start()},load:function(a){function b(a){d.add(Y.createTask({name:'Load Table "'+a.name+'"',execute:function(b){a.load(b)},undo:function(b){b(null,a)}}))}var c=this,d=new Y({name:"Load Database",debug:!!this.server.options.debug}),e=A(a);return c.emit("loadstart:database",c),d.one("complete",function(){c.emit("load:database",c),e(null)}),d.one("rollback",function(a,b){e(b)}),d.add(Y.createTask({name:"Create DB Tables",execute:function(a){c.read(function(d,e){if(d)return a(d,c);if(c.tables={},!e||!e.tables)return a(null,c);for(var f in e.tables){var g=new Qb(f,c);c.tables[g.name]=g,b(g)}return c._isDirty=!1,a(null,c)})},undo:function(a){console.warn("Undoing Create DB Tables task"),a()}})),d.start(),c},createTable:function(a,b){var c,d,e,f=A(b),g=this;if(g.tables.hasOwnProperty(a.name)&&!a.ifNotExists)return f(new Kb('Table "%s" already exists',a.name),null);for(c=new Qb(a.name,g),e=a.fields.length,d=0;e>d;d++)c.addColumn(a.fields[d]);for(e=a.constraints.length,d=0;e>d;d++)c.addConstraint(a.constraints[d]);g.tables[a.name]=c,g._isDirty=!0,c.save(function(b){return b?(delete g.tables[a.name],f(b,null)):void f(null,c)})},getTable:function(a,b){var c=this.tables[a];if(!c){if(b===!1)return null;throw new Kb('No such table "%s" in database "%s"',a,this.name)}return c}}),Qb=Nb.extend({construct:function(a,b){Nb.prototype.construct.call(this,"table"),this.name=a,this.rows={},this.keys={},this.cols={},this._col_seq=[],this._row_seq=[],this._length=0,this._ai=1,this.parent=this._db=b,this.storage=b.storage,this.bubbleTarget=b,this.children=this.rows},toJSON:function(){var a={name:this.name,columns:{},keys:{},rows:this._row_seq};for(var b in this.cols)a.columns[b]=this.cols[b].toJSON();for(b in this.keys)a.keys[b]=this.keys[b].toJSON();return a},getStorageKey:function(){return[bb,this._db.name,this.name].join(".")},addConstraint:function(a){if(a.type==$.TYPE_INDEX||a.type==$.TYPE_UNIQUE||a.type==$.TYPE_PRIMARY){var b=$.fromJSON(a,this);this.keys[b.name]=b;for(var c=0,d=a.columns.length;d>c;c++)this.cols[a.columns[c]].setKey(a.type);this._isDirty=!0}},addColumn:function(a){var b=Ub.create(a);switch(b.key){case"PRIMARY":this.keys[b.name]=new $(this,[b.name],$.TYPE_PRIMARY,b.name);break;case"UNIQUE":this.keys[b.name]=new $(this,[b.name],$.TYPE_UNIQUE,b.name);break;case"KEY":case"INDEX":this.keys[b.name]=new $(this,[b.name],$.TYPE_INDEX,b.name)}return this.cols[a.name]=b,this._col_seq.push(a.name),this._isDirty=!0,b.key,b},_insertRow:function(a,b){for(var c=new qc(this,b),d=0;d<a.length;d++)c._data[d]=this.cols[this._col_seq[d]].set(a[d]);for(var e in this.keys)this.keys[e].beforeInsert(c);this._ai=Math.max(this._ai,b)+1,this._length++,this._row_seq.push(b),this.rows[b]=c,this._isDirty=!0},load:function(a){var b=this,c=A(a);b.emit("loadstart:table",b),b.read(function(a,d){if(a)return c(a);if(!d)return b.emit("load:table",b),c(null,b);b.cols={},b.rows={},b.keys={},b._row_seq=[],b._col_seq=[],b._length=0,b._ai=1,b.primaryKey=null;for(var e in d.columns)b.addColumn(d.columns[e]);if(d.keys){b.keys={},b.primaryKey=null;for(e in d.keys)b.keys[e]=$.fromJSON(d.keys[e],b)}for(var f=[],g=b.getStorageKey(),h=d.rows.length,i=0;h>i;i++)f.push(g+"."+d.rows[i]);f.length?b.storage.getMany(f,function(a,e){return a?c(a):(n(e,function(a,c){b._insertRow(a,d.rows[c])}),b._isDirty=!1,b.emit("load:table",b),void c(null,b))}):(b._isDirty=!1,b.emit("load:table",b),c(null,b))})},insert:function(a,b,c){function d(c){var d;g.add(Y.createTask({name:"Insert row "+c,execute:function(f){var g,i=new qc(e,e._ai);try{for(g=0;h>g;g++)i.setCellValue(a[g],b[c][g]);for(g in e.keys)e.keys[g].beforeInsert(i);d=e._ai++,e.rows[d]=i,e._length++,e._row_seq.push(d),e._isDirty=!0,i._isDirty=!0}catch(j){return f(j)}i.save(f)},undo:function(a){return d?e.rows[d].drop(a):void a()}}))}var e=this,f=A(c),g=new Y({name:"Insert into table "+e.name,debug:e._db.server.options.debug,autoRollback:!0}),h=a.length,i=b.length;g.one("complete",function(){f(null,e)}),g.one("rollback",function(a,b){f(b,null)}),g.add(Y.createTask({name:"insert",execute:function(a){for(var b=0;i>b;b++)d(b);a()},undo:function(a){a()}})),g.start()},update:function(a,b,c,d,e){function f(a){if(k)return!0;if(k=!0,a&&a instanceof Lb)switch(b){case"ROLLBACK":j.setOption("reqursiveRollback",!0),j.one("rollback",function(){e&&e(a),console.info("Update lolled back!")}),j.rollback();break;case"FAIL":e&&e(a);break;case"IGNORE":j.next();break;case"REPLACE":break;default:j.setOption("reqursiveRollback",!1),j.one("rollback",function(){e&&e(a),console.info("Update lolled back!")}),j.rollback()}else e&&e(a)}function h(b,c){var d=b.toJSON("object"),e=Y.createTask({name:"Update row "+b.getStorageKey(),execute:function(d){var e;try{for(e in a)c[e]=K(a[e],c);if(!b.emit("beforeupdate:row",b))return d(null);for(var f in i.keys)i.keys[f].beforeUpdate(b,c);for(e in a)b.setCellValue(e,c[e]);b.emit("update:row",b),d(null)}catch(g){d(g)}},undo:function(a){for(var c in d)b.setCellValue(c,d[c]);a()}});j.add(e)}if(!this.emit("beforeupdate:table",this))return e(null,g('The UPDATE procedure of table "%s" was canceled by a "beforeupdate:table" event listener',this.getStorageKey()));var i=this,j=new Y({name:"Update "+i.name+" transaction",autoRollback:!1,onError:f,onComplete:function(){i.save(function(a){return a?e(a):(i.emit("update:table",i),void d())})}}),k=!1;n(i.rows,function(a){var b=a.toJSON("object");return c&&!K(c,b)?!0:void h(a,b)}),j.start()},drop:function(a){var b,c=this,d=c.getStorageKey(),e=[],f=A(a);if(!c.emit("before_delete:table",c))return f(g('"%s" event  canceled',"before_delete:table"),c);for(b in c.rows)e.push(d+"."+b);c.storage.unsetMany(e,function(a){return a?f(a,c):void Nb.prototype.drop.call(c,function(a){return a?f(a,c):(delete c._db.tables[c.name],void c._db.save(function(a){return a?f(a,c):(c.emit("after_delete:table",c),void f(null,c))}))})})},deleteRows:function(a,b){var c=this,d=[],e=A(b);a=j(a),n(a,function(a){d.push(a.getStorageKey())}),c.storage.unsetMany(d,function(b){return b?e(b):(n(a,function(a){for(var b in c.keys)c.keys[b].beforeDelete(a);var d=u(c._row_seq,a.id,$.compare);d>=0&&(delete c.rows[a.id],c._row_seq.splice(d,1))}),d=null,c._isDirty=!0,void c.save(function(a){e(a)}))})}}),Rb="(\\d{4})\\s*-\\s*(\\d{1,2})\\s*-\\s*(\\d{1,2})",Sb="(\\d{1,3})\\s*:\\s*(\\d{1,2})\\s*:\\s*(\\d{1,2})",Tb=Rb+"\\s+"+Sb,Ub=(new RegExp("^\\s*"+Rb+"\\s*$"),new RegExp("^\\s*"+Sb+"\\s*$"),new RegExp("^\\s*"+Tb+"\\s*$"),new RegExp("^\\s*({\\d{6}|\\d{8}|\\d{12}|\\d{14})\\s*$"),R.extend({key:b,name:null,length:-1,type:null,nullable:!1,setName:function(a){if(a&&(a=l(a)))return this.name=a,this;throw new Kb('Invalid column name "%s".',a)},setKey:function(a){var c=String(a).toUpperCase();this.key=a===$.TYPE_INDEX?"INDEX":"INDEX"==c||"KEY"==c?c:a===$.TYPE_UNIQUE||"UNIQUE"==c?"UNIQUE":a===$.TYPE_PRIMARY||"PRIMARY"==c?"PRIMARY":b},setDefaultValue:function(a){this.defaultValue=a===b?a:this.set(a)},init:function(a){return this.setName(a.name),this.setKey(a.key),this.setDefaultValue(a.defaultValue),this.nullable=!!a.nullable,this},toJSON:function(){var a={name:this.name,key:this.key,defaultValue:this.defaultValue,nullable:!!this.nullable,type:{name:this.type,params:this.typeParams.slice()}};return a},typeToSQL:function(){var a=[this.type];return this.typeParams.length&&a.push("(",this.typeParams.join(", "),")"),a.join("")},get:function(a){return a},construct:function(){this.typeParams=[]}},{create:function(a){var b,c=a.type.name.toUpperCase(),d=pc[c];if(!d)throw new Kb('Unknown data type "%s".',a.type.name);return b=new d,b.init(a),b}})),Vb=Ub.extend({constructor:Vb,unsigned:!1,zerofill:!1,autoIncrement:!1,minUnsigned:0,minSigned:-1,maxUnsigned:2,maxSigned:1,max:1,min:-1,init:function(a){this.setUnsigned(a.unsigned),r(a.type.params)&&a.type.params.length>0&&(this.setLength(a.type.params[0]),this.typeParams=[this.length]),this.setAutoIncrement(a.autoIncrement),this.zerofill=!!a.zerofill,Ub.prototype.init.call(this,a)},setAutoIncrement:function(a){this.autoIncrement=!!a},setUnsigned:function(a){this.unsigned=!!a,this.min=this.unsigned?this.minUnsigned:this.minSigned,this.max=this.unsigned?this.maxUnsigned:this.maxSigned},setLength:function(a){var b=String(this.max).length;if(a=parseInt(a,10),isNaN(a)||!isFinite(a)||1>a||a>b)throw new Kb('Invalid length for column "%s". The length must be between 1 and %s inclusive.',this.name,b);this.length=a},toJSON:function(){var a={name:this.name,unsigned:this.unsigned,zerofill:this.zerofill,key:this.key,defaultValue:this.defaultValue===b?this.defaultValue:String(this.defaultValue),autoIncrement:this.autoIncrement,nullable:this.nullable,type:{name:this.type,params:this.typeParams.slice()}};return a},toSQL:function(){var a=[i(this.name),this.typeToSQL(),this.nullable?"NULL":"NOT NULL"];return this.unsigned&&a.push("UNSIGNED"),this.zerofill&&a.push("ZEROFILL"),this.autoIncrement&&a.push("AUTO_INCREMENT"),"PRIMARY"==this.key?a.push("PRIMARY KEY"):"UNIQUE"==this.key?a.push("UNIQUE"):"INDEX"==this.key&&a.push("KEY"),this.defaultValue!==b&&a.push("DEFAULT",i(this.defaultValue,"'")),a.join(" ")}}),Wb=Vb.extend({type:"BIT",init:function(a){if(Vb.prototype.init.call(this,a),r(a.type.params)&&a.type.params.length>0){if(1!==a.type.params.length)throw new Kb('Invalid data type declaration for column "%s". The syntax is "INT[(length)]".',a.name);this.setLength(a.type.params[0]),this.typeParams=[this.length]}},setLength:function(a){if(a=parseInt(a,10),isNaN(a)||!isFinite(a)||1>a||a>64)throw new Kb('Invalid length for column "%s". The length must be between 1 and 64 inclusive.',this.name);this.length=a},set:function(a){var b,c=String(a),d=c.length;if(d>this.length)throw new Kb('The data ("%s") is too long for the field "%s". It may contain up to %s bits',c,this.name,this.length);if(b=parseInt(c,2),isNaN(b)||!isFinite(b))throw new Kb('Invalid bit field value for column "%s". Expecting up to %s bits as binary number literal',this.name,this.length);for(;d++<this.length;)c="0"+c;return c}}),Xb=Vb.extend({type:"INT",minUnsigned:0,minSigned:-2147483648,maxUnsigned:4294967295,maxSigned:2147483647,init:function(a){if(Vb.prototype.init.call(this,a),r(a.type.params)&&a.type.params.length>0){if(1!==a.type.params.length)throw new Kb('Invalid data type declaration for column "%s". The syntax is "INT[(length)]".',a.name);this.setLength(a.type.params[0]),this.typeParams=[this.length]}},setLength:function(a){var b=String(this.minSigned).length;if(a=parseInt(a,10),isNaN(a)||!isFinite(a)||1>a||a>b)throw new Kb('Invalid length for column "%s". The length must be between 1 and %s inclusive.',this.name,b);this.length=a},set:function(a){if(null===a){if(this.nullable||this.autoIncrement)return a;throw new Kb('Column "%s" cannot be NULL.',this.name)}var b=parseInt(a,10);if(isNaN(b)||!isFinite(b)||b<this.min||b>this.max)throw new Kb('Invalid value "%s" for column "%s". Expecting an integer between %s and %s.',String(a),this.name,this.min,this.max);return b}}),Yb=Xb.extend({type:"INTEGER"}),Zb=Xb.extend({type:"TINYINT",minUnsigned:0,minSigned:-128,maxUnsigned:255,maxSigned:127}),$b=Xb.extend({type:"SMALLINT",minUnsigned:0,minSigned:-32768,maxUnsigned:65535,maxSigned:32767}),_b=Xb.extend({type:"MEDIUMINT",minUnsigned:0,minSigned:-8388608,maxUnsigned:16777215,maxSigned:8388607}),ac=Xb.extend({type:"BIGINT",minUnsigned:0,minSigned:-0x8000000000000000,maxUnsigned:0x10000000000000000,maxSigned:0x8000000000000000}),bc=Vb.extend({type:"DECIMAL",length:10,decimals:0,minUnsigned:Xb.prototype.minUnsigned,minSigned:Xb.prototype.minSigned,maxUnsigned:Xb.prototype.maxUnsigned,maxSigned:Xb.prototype.maxSigned,min:Xb.prototype.minUnsigned,max:Xb.prototype.maxUnsigned,init:function(a){if(Vb.prototype.init.call(this,a),r(a.type.params)){if(1!==a.type.params.length)throw new Kb('Invalid data type declaration for column "%s". The syntax is "%s[(length)]".',a.name,this.type.toUpperCase());
this.setLength(a.type.params[0]),this.typeParams=[this.length]}this.setDefaultValue(a.defaultValue)},set:function(a){var b=parseFloat(a);if(isNaN(b)||!isFinite(b)||b<this.min||b>this.max)throw new Kb('Invalid value "%s" for column "%s". Expecting a number between %s and %s.',String(a),this.name,this.min,this.max);return b=Number(a).toPrecision(this.length),Number(b).toFixed(this.decimals)}}),cc=bc.extend({type:"NUMERIC"}),dc=Vb.extend({type:"DOUBLE",length:10,decimals:2,minUnsigned:Xb.prototype.minUnsigned,minSigned:Xb.prototype.minSigned,maxUnsigned:Xb.prototype.maxUnsigned,maxSigned:Xb.prototype.maxSigned,init:function(a){if(Vb.prototype.init.call(this,a),r(a.type.params)){if(1!==a.type.params.length)throw new Kb('Invalid data type declaration for column "%s". The syntax is "%s[(length)]".',a.name,this.type.toUpperCase());this.setLength(a.type.params[0]),this.typeParams=[this.length]}},set:function(a){var b=parseFloat(a);if(isNaN(b)||!isFinite(b)||b<this.min||b>this.max)throw new Kb('Invalid value "%s" for column "%s". Expecting a number between %s and %s.',String(a),this.name,this.min,this.max);b=Number(a).toPrecision(this.length);var c=Math.pow(10,this.decimals);return Math.round(b*c)/c}}),ec=Vb.extend({type:"FLOAT",length:10,decimals:2,minUnsigned:Xb.prototype.minUnsigned,minSigned:Xb.prototype.minSigned,maxUnsigned:Xb.prototype.maxUnsigned,maxSigned:Xb.prototype.maxSigned,init:function(a){if(Vb.prototype.init.call(this,a),this.typeParams=[this.length],r(a.type.params)){if(a.type.params.length>2)throw new Kb('Invalid data type declaration for column "%s". The syntax is "%s[(length[, decimals])]".',a.name,this.type.toUpperCase());this.typeParams=[],a.type.params.length>0&&(this.setLength(a.type.params[0]),this.typeParams[0]=this.length),a.type.params.length>1&&(this.decimals=d(a.type.params[1]),this.typeParams[1]=this.decimals)}},set:function(a){var b=parseFloat(a);if(isNaN(b)||!isFinite(b)||b<this.min||b>this.max)throw new Kb('Invalid value "%s" for column "%s". Expecting a number between %s and %s.',String(a),this.name,this.min,this.max);b=Number(a).toPrecision(this.length);var c=Math.pow(10,this.decimals);return Math.round(b*c)/c}}),fc=Ub.extend({type:"STRING",length:-1,maxLength:Number.MAX_VALUE,init:function(a){r(a.type.params)&&a.type.params.length>0&&"-1"!=String(a.type.params[0])&&(this.setLength(a.type.params[0]),this.typeParams=[this.length]),Ub.prototype.init.call(this,a)},setLength:function(a){if(a=parseInt(a,10),isNaN(a)||!isFinite(a)||0>a)throw new Kb('Invalid length for column "%s". The length must be a positive integer.',this.name);this.length=Math.min(a,this.maxLength)},set:function(a){var b,c=String(a);if(-1==this.length)return c;if(b=c.length,b>this.length)throw new Kb('Truncated value for column "%s".',this.name);return c},toSQL:function(){var a=[i(this.name),this.typeToSQL(),this.nullable?"NULL":"NOT NULL"];return"PRIMARY"==this.key?a.push("PRIMARY KEY"):"UNIQUE"==this.key?a.push("UNIQUE"):"INDEX"==this.key&&a.push("KEY"),this.defaultValue!==b&&a.push("DEFAULT",i(this.defaultValue,"'")),a.join(" ")}}),gc=fc.extend({type:"VARCHAR",length:-1,maxLength:65535}),hc=fc.extend({type:"CHAR",length:-1,maxLength:65535}),ic=fc.extend({type:"ENUM",setLength:function(){},init:function(a){if(!r(a.type.params)||a.type.params.length<1)throw new Kb('The "%s" column type requires at least one option.',this.type);this.typeParams=a.type.params.slice(),Ub.prototype.init.call(this,a)},set:function(a){var b=String(a);if(-1==this.typeParams.indexOf(b))throw new Kb('The value for column "%s" must be %s.',this.name,h(this.optionSet));return b},typeToSQL:function(){var a=[this.type];if(this.typeParams.length){a.push("(");for(var b=0,c=this.typeParams.length;c>b;b++)a.push(i(this.typeParams[b],"'")),c-1>b&&a.push(", ");a.push(")")}return a.join("")}}),jc=Ub.extend({set:function(a){if(null===a){if(this.nullable||this.autoIncrement)return a;throw new Kb('Column "%s" cannot be NULL.',this.name)}var b=G(a);if(isNaN(1*b))throw new Jb('Invalid value "%s" for column "%s".',a+" ("+typeof a+")",this.name);return b.getTime()}}),kc=jc.extend({type:"DATE",get:function(a){return null===a?"0000-00-00":I("%Y-%m-%d",a)}}),lc=jc.extend({type:"YEAR",get:function(a){return null===a?"0000":I("%Y",a)}}),mc=jc.extend({type:"DATETIME",format:"%Y-%m-%d %H:%M:%S",init:function(a){if(r(a.type.params)&&a.type.params.length>0){var b=a.type.params[0];t(b)?this.fps=d(b):this.format=b,this.typeParams=[this.length]}console.log(this),Ub.prototype.init.call(this,a)},get:function(a){return null===a?"0000-00-00 00:00:00":I(this.format,a)}}),nc=jc.extend({type:"TIME",get:function(a){return null===a?"00:00:00":I("%H:%M:%S",a)}}),oc=jc.extend({type:"TIMESTAMP",init:function(a){r(a.type.params)&&a.type.params.length>0?(this.setLength(a.type.params[0]),this.typeParams=[this.length]):this.setLength(14),Ub.prototype.init.call(this,a)},setLength:function(a){var b={4:1,6:1,8:1,10:1,12:1,14:1};if(a=parseInt(a,10),isNaN(a)||!isFinite(a)||!(a in b))throw new Kb('Invalid length for column "%s". The length (if specified) must be %s.',this.name,h(b));this.length=a},set:function(a){null===a&&(a="now");var b=G(a);if(isNaN(1*b))throw new Jb('Invalid value "%s" for column "%s".',a+" ("+typeof a+")",this.name);return b.getTime()},get:function(a){if(null===a)return a;var b=new Date(a),c=[b.getFullYear()];return this.length>4&&c.push(C(b.getMonth()+1,2)),this.length>6&&c.push(C(b.getDate(),2)),this.length>8&&c.push(C(b.getHours(),2)),this.length>10&&c.push(C(b.getMinutes(),2)),this.length>12&&c.push(C(b.getSeconds(),2)),c.join("")}}),pc={BIT:Wb,TINYINT:Zb,SMALLINT:$b,MEDIUMINT:_b,INT:Xb,INTEGER:Yb,BIGINT:ac,DOUBLE:dc,FLOAT:ec,DECIMAL:bc,NUMERIC:cc,DATE:kc,TIME:nc,TIMESTAMP:oc,DATETIME:mc,YEAR:lc,CHAR:hc,VARCHAR:gc,ENUM:ic},qc=Nb.extend({construct:function(a,b){Nb.prototype.construct.call(this,"row",a),this.id=b,this.table=a,this.length=0,this._data=[],this._cellsByName={},this.setTable(a)},getStorageKey:function(){return[bb,this.table._db.name,this.table.name,this.id].join(".")},load:function(a){var b=this,c=A(a);b.emit("loadstart:row",b),b.read(function(a,d){if(a)return c(a,null);if(d&&d.length)for(var e=0;e<b.length;e++)b._data[e]=b.table.cols[b.table._col_seq[e]].set(d[e]);b._isDirty=!1,b.emit("load:row",b),c(null,b)})},setTable:function(a){var c,d;this.length=0,this._cellsByName={},this.parent=this.table=a,this._data=[],this.storage=a.storage,this.bubbleTarget=a;for(c in a.cols)d=a.cols[c],this._cellsByName[c]=this.length,d.defaultValue!==b?this.setCellValue(this.length,d.defaultValue):d.nullable&&this.setCellValue(this.length,null),this.length++;return this._isDirty=!1,this},getCell:function(a){return y(a,this._cellsByName,'No such field "'+a+'".'),this.table.cols[a].get(this._data[this._cellsByName[a]])},getCellAt:function(a){return x(a,this._data,'No field at index "'+a+'".'),this.table.cols[this.table._col_seq[a]].get(this._data[a])},setCellValue:function(a,b){var c,d=t(a),e=d?this.table.cols[this.table._col_seq[a]]:this.table.cols[a],f=d?this._data[a]:this._data[this._cellsByName[a]];return b===f?this:(c=e.set(b),c===f?this:(null===c&&e.autoIncrement&&(c=this.table._ai),this._data[d?a:this._cellsByName[a]]=c,c!==f&&(this._isDirty=!0),this))},getCellValue:function(a){return t(a)?this.getCellAt(a):this.getCell(a)},toJSON:function(a){if(!a||"array"==a)return this._data.slice();var b,c={};if("object"==a||"mixed"==a)for(b in this._cellsByName)c[b]=this.getCell(b);if("mixed"==a)for(b=0;b<this.length;b++)c[b]=this.getCellAt(b);return c}});$.TYPE_INDEX=2,$.TYPE_UNIQUE=4,$.TYPE_PRIMARY=8,$.compare=function(a,b){return a===b?0:a>b?1:-1},$.fromJSON=function(a,b){var c=new $(b,a.columns,a.type,a.name);return c},$.prototype={init:function(){var a,b,c,d,e,f=this.table._row_seq,g=this.table.rows,h=this.table._length,i=this.columns.length;for(this._index=[],c=0;h>c;c++){for(b=f[c],a=[],d=0;i>d;d++)a.push(g[b].getCell(this.columns[d]));a=a.join(""),e=u(this._index,a,$.compare),this._index.splice(0>e?-e-1:e+1,0,a)}},getValueForRow:function(a){var b,c="",d=this.columns.length;if(0===d)return c;if(1===d)return String(a instanceof qc?a.getCell(this.columns[0]):a[this.columns[0]]);for(b=0;d>b;b++)c.push(a instanceof qc?a.getCell(this.columns[b]):a[this.columns[b]]);return c.join("")},beforeInsert:function(a){var b,c,d=[];for(b=0;b<this.columns.length;b++)d.push(a.getCell(this.columns[b]));if(d=d.join(""),c=u(this._index,d,$.compare),c>=0&&this.isUnique())throw new Kb('Duplicate entry for key "%s".',this.name);c=0>c?-c-1:c+1,this._index.splice(c,0,d)},beforeUpdate:function(a,b){var c,d,e=this.getValueForRow(a),f=this.getValueForRow(b);if(e!==f){if(c=u(this._index,e,$.compare),d=u(this._index,f,$.compare),d>=0&&this.isUnique())throw new Lb('Constraint "%s" violated. The value must be unique and the supplied value "%s" already exists.',this.name,f);c!==d&&(d=0>d?-d-1:d+1,this._index.splice(d,0,f),c=c>=d?c+1:c,this._index.splice(c,1))}},beforeDelete:function(a){var b,c=[];for(b=0;b<this.columns.length;b++)c.push(a.getCell(this.columns[b]));c=c.join(""),b=u(this._index,c,$.compare),b>=0&&this._index.splice(b,1)},setColumns:function(a){v(a,"Array"),this.columns=a.slice()},setType:function(a){switch(a){case $.TYPE_UNIQUE:this.type=a;break;case $.TYPE_PRIMARY:if(this.table.primaryKey)throw new Kb("A table can only have one PRIMARY KEY defined");this.type=a,this.table.primaryKey=this;break;default:this.type=a}},setTable:function(a){w(a,Qb),this.table=a},setName:function(a){if(v(a,"String","The name of the index must be a string"),a=l(a),z(a,"The name of the index cannot be empty"),a in this.table.keys)throw new Kb('The table %s.%s already have a key named "%s".',this.table._db.name,this.table.name,a);this.name=a},isUnique:function(){return this.type===$.TYPE_UNIQUE||this.type===$.TYPE_PRIMARY},toJSON:function(){return{name:this.name,type:this.type,columns:this.columns}}},a[bb]=cb,a.jsSQL=T,cb.Result=_,a.JSDB_EXPORT_FOR_TESTING&&B(a.JSDB,{TOKEN_TYPE_UNKNOWN:db,TOKEN_TYPE_WORD:eb,TOKEN_TYPE_NUMBER:fb,TOKEN_TYPE_OPERATOR:gb,TOKEN_TYPE_SINGLE_QUOTE_STRING:hb,TOKEN_TYPE_DOUBLE_QUOTE_STRING:ib,TOKEN_TYPE_BACK_TICK_STRING:jb,TOKEN_TYPE_SUBMIT:kb,TOKEN_TYPE_COMMENT:lb,TOKEN_TYPE_MULTI_COMMENT:mb,TOKEN_TYPE_PUNCTOATOR:nb,TOKEN_TYPE_SPACE:ob,TOKEN_TYPE_EOL:pb,TOKEN_TYPE_EOF:qb,tokenize:W,getTokens:m,getQueries:P,normalizeQueryList:Q,Walker:X,Table:Qb,TableIndex:$,Column:Ub,TableRow:qc,binarySearch:u,crossJoin:M,innerJoin:N,crossJoin2:L,executeCondition:K,Transaction:Y,SQLConstraintError:Lb,SQLRuntimeError:Kb,SQLParseError:Jb,parseDate:G,strftime:I,parseISO8601:F,prependZero:C}),_.TYPE_UNKNOWN=0,_.TYPE_ARRAY=2,_.TYPE_SET=4,_.TYPE_MESSAGE=8,_.TYPE_BOOL=16,_.TYPE_MUTATION=32,_.prototype={setData:function(a){return this._endTime=Date.now(),this.time=this._endTime-this._startTime,this._startTime=this._endTime,a&&"object"==typeof a?(this.data=a,this.cols=a.cols||[],this.rows=a.rows||[],this.type=_.TYPE_SET):"[object Array]"==Object.prototype.toString.call(a)?(this.data=a,this.rows=a,this.cols=[],this.type=_.TYPE_ARRAY):a===!0||a===!1?(this.data=a,this.cols=[],this.rows=[],this.type=_.TYPE_BOOL):(this.data=String(a||""),this.cols=[],this.rows=[],this.type=_.TYPE_MESSAGE),this.colLength=this.cols.length,this.rowLength=this.rows.length,this},isSuccess:function(){return this.type===_.TYPE_UNKNOWN?!1:this.type!==_.TYPE_BOOL||this.data?!0:!1},getMessage:function(){return this.isSuccess()?this.type===_.TYPE_MESSAGE?this.data:this.type===_.TYPE_ARRAY||this.type===_.TYPE_SET?this.rowLength+" rows in set. Query took "+this.time+"ms.":this.type===_.TYPE_MUTATION?this.data+" rows affected. Query took "+this.time+"ms.":"Query executed successfully in "+this.time+"ms.":"Query failed"},toHTML:function(a){var c,d,e,f,g=[],h=this.cols.length,i=this.rows.length;if(g.push("<table"),a){g.push(" "),c=[];for(f in a)c.push(f+"="+escape(a[f]));g.push(c.join(" "))}for(g.push("><thead><tr>"),d=0;h>d;d++)g.push("<th>",this.cols[d],"</th>");for(g.push("</tr></thead><tbody>"),d=0;i>d;d++){for(c=this.rows[d],g.push("<tr>"),e=0;h>e;e++)f=c[this.cols[e]],g.push("<td>",f===b?"":null===f?"NULL":String(f),"</td>");g.push("</tr>")}return g.push("</tbody></table>"),g.join("")},toJSON:function(){var a={message:this.getMessage(),queryTime:this.time,successful:this.isSuccess()};return a.successful&&(this.type===_.TYPE_MUTATION&&(a.affectedRows=this.data),this.type===_.TYPE_ARRAY&&(a.rows=this.rows,a.rowLength=this.rowLength),this.type===_.TYPE_SET&&(a.rows=this.rows,a.cols=this.cols,a.rowLength=this.rowLength,a.colLength=this.colLength)),a},toJSONString:function(a){return JSON.stringify(this.toJSON(),null,a||0)},toString:function(a,c){var d=this,e=[];return this.forEach(function(a){var f,g,h=[];for(f=0;f<d.colLength;f++)g=a[d.cols[f]]||a[f],h.push(g===b?";":String(g));e.push(h.join(c===b?",":String(c)))}),e.join(a===b?"\n":String(a))},toXML:function(a){var c=this,d=["<result>"],e=this.isSuccess();return d.push(a?"\n":"",a||"","<successful>",e,"</successful>"),d.push(a?"\n":"",a||"","<message>",this.getMessage(),"</message>"),d.push(a?"\n":"",a||"","<queryTime>",this.time,"</queryTime>"),e&&(this.type===_.TYPE_MUTATION&&d.push(a?"\n":"",a||"","<affectedRows>",this.data,"</affectedRows>"),this.type===_.TYPE_ARRAY&&d.push(a?"\n":"",a||"","<rowLength>",this.rowLength,"</rowLength>"),this.type===_.TYPE_SET&&(d.push(a?"\n":"",a||"","<rowLength>",this.rowLength,"</rowLength>"),d.push(a?"\n":"",a||"","<colLength>",this.colLength,"</colLength>")),(this.type===_.TYPE_ARRAY||this.type===_.TYPE_SET)&&this.forEach(function(e){var f,g,h=[];for(h.push(a?"\n":"",a||"","<row>"),f=0;f<c.colLength;f++)g=e[c.cols[f]]||e[f],h.push(a?"\n":"",a||"",a||"","<property>",g===b?"":String(g),"</property>");h.push(a?"\n":"",a||"","</row>"),d.push(h.join(""))})),d.push(a?"\n":"","</result>"),d.join("")},toCSV:function(){return this.toString("\n",",")},forEach:function(a){for(var b=0;b<this.rowLength&&a(this.rows[b],b,this.rows)!==!1;b++);}},T.version="0.1.153"}(window);