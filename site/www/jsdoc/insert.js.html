<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: statements/insert.js</title>
    
    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">
    
    <h1 class="page-title">Source: statements/insert.js</h1>
    
    


    
    <section>
        <article>
            <pre class="prettyprint source"><code>/**
 * @memberof STATEMENTS
 * @type {Function}
 * @param {Walker} walker - The walker instance used to parse the current 
 * statement
 * @return {void}
 */
STATEMENTS.INSERT = function(walker) {
	var dbName, 
		tableName, 
		table,
		or, 
		valueSets = [], 
		columns;
	
	function columnsList(notFirst) {
		
		if (!notFirst) {
			columns = [];
		}
		
		walker.someType(WORD_OR_STRING, function(token) {
			columns.push(token[0]);
		})
		.pick({
			"," : function() {
				columnsList(true);
			},
			")" : noop
		});
	}
	
	function valueList(set) {
		walker.literalValue(function(token) {
			var value = token[0];
			if (token[1] === TOKEN_TYPE_WORD) {
				value = value.toUpperCase();
				if (value == "NULL") {
					value = null;
				}
			}
			set.push(value);
		})
		.optional({
			"," : function() {
				valueList(set);
			}
		});
	}
	
	function valueSet() {
		walker.pick({
			"(" : function() {
				var set = [];
				valueList(set);
				walker.pick({
					")" : function() {
						var cl = columns.length, 
							sl = set.length; 
						if (cl !== sl) {
							throw new SQLParseError(
								'The number of inserted values (%s) must ' + 
								'match the number of used columns (%s)',
								sl,
								cl
							);
						}
						valueSets.push(set);	
					}
				});
			}
		}).optional({
			"," : valueSet
		});
	}
	
	return new Task({
		name : "Insert Query",
		execute : function(done, fail) {
			walker
			// TODO: with-clause
			
			// Type of insert ------------------------------------------------------
			.optional({ 
				"OR" : function() {
					walker.pick({
						"REPLACE"  : function() { or = "REPLACE" ; },
						"ROLLBACK" : function() { or = "ROLLBACK"; },
						"ABORT"    : function() { or = "ABORT"   ; },
						"FAIL"     : function() { or = "FAIL"    ; },
						"IGNORE"   : function() { or = "IGNORE"  ; },
					});
				}
			})
			
			.pick({ "INTO" : noop })
			
			// table ---------------------------------------------------------------
			.someType(WORD_OR_STRING, function(token) {
				tableName = token[0];
			})
			.optional(".", function() {
				walker.someType(WORD_OR_STRING, function(token) {
					dbName = tableName;
					tableName = token[0];
				});
			});
			
			table = getTable(tableName, dbName);
			columns = keys(table.cols);
			
			// Columns to be used --------------------------------------------------
			walker.optional({ "(" : columnsList })
			
			// Values to insert ----------------------------------------------------
			.pick({
				// TODO: Support for select statements here
				//"DEFAULT VALUES" : function() {
					// TODO
				//},
				"VALUES" : valueSet
			})
			
			// Finalize ------------------------------------------------------------
			.errorUntil(";")
			.commit(function() {
				/*console.dir({
					dbName    : dbName, 
					tableName : tableName, 
					table     : table,
					or        : or, 
					valueSets : valueSets,
					columns   : columns
				});*/
				table.insert(columns, valueSets);
				done(valueSets.length + ' rows inserted.');
			});
		},
		undo : function(done, fail) {
			fail("undo not implemented for INSERT queries!");
		}
	});
};</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Index</a></h2><h3>Classes</h3><ul><li><a href="Column.html">Column</a></li><li><a href="Column_BIGINT.html">Column_BIGINT</a></li><li><a href="Column_BIT.html">Column_BIT</a></li><li><a href="Column_ENUM.html">Column_ENUM</a></li><li><a href="Column_INT.html">Column_INT</a></li><li><a href="Column_INTEGER.html">Column_INTEGER</a></li><li><a href="Column_MEDIUMINT.html">Column_MEDIUMINT</a></li><li><a href="Column_SMALLINT.html">Column_SMALLINT</a></li><li><a href="Column_TINYINT.html">Column_TINYINT</a></li><li><a href="CreateDatabaseQuery.html">CreateDatabaseQuery</a></li><li><a href="CreateTableQuery.html">CreateTableQuery</a></li><li><a href="CustomError.html">CustomError</a></li><li><a href="Database.html">Database</a></li><li><a href="LocalStorage.html">LocalStorage</a></li><li><a href="MemoryStorage.html">MemoryStorage</a></li><li><a href="NumericColumn.html">NumericColumn</a></li><li><a href="Persistable.html">Persistable</a></li><li><a href="Result.html">Result</a></li><li><a href="Server.html">Server</a></li><li><a href="SQLConstraintError.html">SQLConstraintError</a></li><li><a href="SQLParseError.html">SQLParseError</a></li><li><a href="SQLRuntimeError.html">SQLRuntimeError</a></li><li><a href="Table.html">Table</a></li><li><a href="TableIndex.html">TableIndex</a></li><li><a href="TableRow.html">TableRow</a></li><li><a href="Task.html">Task</a></li><li><a href="Transaction.html">Transaction</a></li><li><a href="Walker.html">Walker</a></li></ul><h3>Namespaces</h3><ul><li><a href="events.html">events</a></li><li><a href="JSDB.html">JSDB</a></li><li><a href="STATEMENTS.html">STATEMENTS</a></li><li><a href="Utils.html">Utils</a></li></ul><h3>Global</h3><ul><li><a href="global.html#createErrorClass">createErrorClass</a></li><li><a href="global.html#getQueries">getQueries</a></li><li><a href="global.html#normalizeQueryList">normalizeQueryList</a></li><li><a href="global.html#NS">NS</a></li><li><a href="global.html#query2">query2</a></li><li><a href="global.html#QueryList">QueryList</a></li><li><a href="global.html#Storage">Storage</a></li><li>{Boolean}</li><li>{String}</li></ul>
</nav>

<br clear="both">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.2.2</a> on Sat Aug 23 2014 08:04:16 GMT+0300 (EEST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
